<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OptionAlpha - æœŸæƒäº¤æ˜“ç­–ç•¥ç³»ç»Ÿ</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Element Plus -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/element-plus"></script>
    <!-- ECharts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #f5f7fa;
            min-height: 100vh;
        }

        .glass-card {
            background: white;
            border-radius: 8px;
            padding: 24px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            border: 1px solid #e8e8e8;
        }

        .stat-card {
            background: white;
            border: 2px solid #2c3e50;
            color: #2c3e50;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: all 0.2s;
        }

        .stat-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .bull-tag {
            background: #f56c6c;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 12px;
        }

        .bear-tag {
            background: #67c23a;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 12px;
        }

        .neutral-tag {
            background: #909399;
            color: white;
            padding: 4px 10px;
            border-radius: 4px;
            font-weight: 600;
            font-size: 12px;
        }

        .chart-container {
            width: 100%;
            height: 400px;
            margin-top: 20px;
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(0, 0, 0, .1);
            border-radius: 50%;
            border-top-color: #409eff;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .header-simple {
            background: white;
            border-bottom: 1px solid #e8e8e8;
        }

        .sentiment-bar {
            height: 20px;
            border-radius: 4px;
            overflow: hidden;
            display: flex;
            margin-top: 8px;
            border: 1px solid #e8e8e8;
        }

        .sentiment-bar-bull {
            background: #f56c6c;
        }

        .sentiment-bar-neutral {
            background: #909399;
        }

        .sentiment-bar-bear {
            background: #67c23a;
        }

        .variety-badge {
            display: inline-block;
            background: #2c3e50;
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
            margin-right: 6px;
            font-size: 12px;
        }

        .info-section {
            background: #fafafa;
            border-left: 3px solid #409eff;
            padding: 16px;
            border-radius: 4px;
            margin-bottom: 16px;
        }

        .top-mover-card {
            padding: 16px;
            background: white;
            border: 1px solid #e8e8e8;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .top-mover-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-2px);
        }

        .top-mover-card.bullish {
            border-left: 4px solid #f56c6c;
        }

        .top-mover-card.bearish {
            border-left: 4px solid #67c23a;
        }
    </style>
</head>

<body>
    <div id="app" class="min-h-screen pb-8">
        <!-- é¡¶éƒ¨å¯¼èˆª -->
        <header class="header-simple shadow-sm">
            <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                <div class="flex justify-between items-center">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-800">OptionAlpha</h1>
                        <p class="text-gray-600 text-sm">æœŸè´§æœŸæƒäº¤æ˜“å››ç»´åˆ†æç³»ç»Ÿ</p>
                    </div>
                    <div class="flex items-center space-x-4">
                        <el-date-picker
                            v-model="selectedDate"
                            type="date"
                            placeholder="é€‰æ‹©æ—¥æœŸ"
                            @change="onDateChange"
                            format="YYYY-MM-DD"
                            value-format="YYYY-MM-DD">
                        </el-date-picker>
                    </div>
                </div>
            </div>
        </header>

        <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <!-- ä¸»å¯¼èˆª -->
            <el-tabs v-model="activeTab" type="card" class="mb-6">
                <el-tab-pane label="ğŸ“Š æ€»è§ˆ" name="overview"></el-tab-pane>
                <el-tab-pane label="ğŸ” å“ç§è¯¦æƒ…" name="variety-detail"></el-tab-pane>
                <el-tab-pane label="ğŸ“° åŸºæœ¬é¢" name="fundamental"></el-tab-pane>
                <el-tab-pane label="ğŸ’° èµ„é‡‘é¢" name="capital"></el-tab-pane>
                <el-tab-pane label="ğŸ“ˆ æœŸé™åˆ†æ" name="term-analysis"></el-tab-pane>
                <el-tab-pane label="ğŸ“‰ æŠ€æœ¯é¢" name="technical"></el-tab-pane>
            </el-tabs>

            <!-- æ€»è§ˆé¡µ - V2åˆ†ææ€»è§ˆ -->
            <div v-if="activeTab === 'overview'" class="space-y-6">
                <!-- ç»Ÿè®¡å¡ç‰‡ -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="stat-card">
                        <div class="text-sm text-gray-600 mb-1">æ€»å“ç§æ•°</div>
                        <div class="text-3xl font-bold">{{ v2Stats.total || 0 }}</div>
                    </div>
                    <div class="stat-card" style="border-color: #10b981;">
                        <div class="text-sm text-gray-600 mb-1">å¤šå¤´å“ç§</div>
                        <div class="text-3xl font-bold" style="color: #10b981;">{{ v2Stats.long || 0 }}</div>
                    </div>
                    <div class="stat-card" style="border-color: #ef4444;">
                        <div class="text-sm text-gray-600 mb-1">ç©ºå¤´å“ç§</div>
                        <div class="text-3xl font-bold" style="color: #ef4444;">{{ v2Stats.short || 0 }}</div>
                    </div>
                    <div class="stat-card" style="border-color: #6b7280;">
                        <div class="text-sm text-gray-600 mb-1">ä¸­æ€§å“ç§</div>
                        <div class="text-3xl font-bold" style="color: #6b7280;">{{ v2Stats.neutral || 0 }}</div>
                    </div>
                </div>

                <!-- ç­›é€‰æŒ‰é’® -->
                <div class="glass-card">
                    <div class="flex justify-between items-center">
                        <el-radio-group v-model="v2FilterDirection" @change="handleV2FilterChange">
                            <el-radio-button label="all">å…¨éƒ¨</el-radio-button>
                            <el-radio-button label="å¤šå¤´">å¤šå¤´</el-radio-button>
                            <el-radio-button label="ç©ºå¤´">ç©ºå¤´</el-radio-button>
                            <el-radio-button label="ä¸­æ€§">ä¸­æ€§</el-radio-button>
                        </el-radio-group>
                        <el-button type="primary" @click="refreshV2Data" :loading="v2Loading">
                            <span v-if="!v2Loading">åˆ·æ–°æ•°æ®</span>
                            <span v-else>åˆ†æä¸­...</span>
                        </el-button>
                    </div>
                </div>

                <!-- V2åˆ†ææ•°æ®è¡¨æ ¼ -->
                <div class="glass-card">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">ğŸ“Š 5ç»´åº¦ç»¼åˆåˆ†æ</h2>
                    <el-table :data="v2FilteredData" stripe style="width: 100%" v-loading="v2Loading" max-height="600">
                        <el-table-column prop="å“ç§" label="å“ç§" width="100" fixed />
                        <el-table-column label="ç»¼åˆæ–¹å‘" width="120">
                            <template #default="scope">
                                <span :class="{
                                    'bull-tag': scope.row.ç»¼åˆæ–¹å‘ === 'å¤šå¤´',
                                    'bear-tag': scope.row.ç»¼åˆæ–¹å‘ === 'ç©ºå¤´',
                                    'neutral-tag': scope.row.ç»¼åˆæ–¹å‘ === 'ä¸­æ€§'
                                }">
                                    {{ scope.row.ç»¼åˆæ–¹å‘ }}
                                </span>
                            </template>
                        </el-table-column>
                        <el-table-column prop="ç»¼åˆæ˜Ÿçº§" label="ç»¼åˆå¼ºåº¦" width="100" />
                        <el-table-column prop="å‡€å¾—åˆ†" label="å‡€å¾—åˆ†" width="100" sortable />

                        <el-table-column label="ç ”æŠ¥" width="120">
                            <template #default="scope">
                                {{ scope.row.ç ”æŠ¥åˆ†æ_æ–¹å‘ }} {{ scope.row.ç ”æŠ¥åˆ†æ_æ˜Ÿçº§ }}
                            </template>
                        </el-table-column>

                        <el-table-column label="è™šå®æ¯”" width="120">
                            <template #default="scope">
                                {{ scope.row.è™šå®æ¯”PCR_æ–¹å‘ }} {{ scope.row.è™šå®æ¯”PCR_æ˜Ÿçº§ }}
                            </template>
                        </el-table-column>

                        <el-table-column label="æœŸé™ç»“æ„" width="140">
                            <template #default="scope">
                                {{ scope.row.æœŸé™ç»“æ„_æ–¹å‘ }} {{ scope.row.æœŸé™ç»“æ„_æ˜Ÿçº§ }}
                            </template>
                        </el-table-column>

                        <el-table-column label="æ³¢åŠ¨ç‡èƒŒç¦»" width="140">
                            <template #default="scope">
                                {{ scope.row.æ³¢åŠ¨ç‡èƒŒç¦»_æ–¹å‘ }} {{ scope.row.æ³¢åŠ¨ç‡èƒŒç¦»_æ˜Ÿçº§ }}
                            </template>
                        </el-table-column>

                        <el-table-column label="èµ„é‡‘é¢" width="120">
                            <template #default="scope">
                                {{ scope.row.èµ„é‡‘é¢_æ–¹å‘ }} {{ scope.row.èµ„é‡‘é¢_æ˜Ÿçº§ }}
                            </template>
                        </el-table-column>

                        <el-table-column label="æ“ä½œ" width="100" fixed="right">
                            <template #default="scope">
                                <el-button type="primary" size="small" @click="viewV2Detail(scope.row.å“ç§)">
                                    è¯¦æƒ…
                                </el-button>
                            </template>
                        </el-table-column>
                    </el-table>
                </div>

                <!-- V2è¯¦æƒ…å¯¹è¯æ¡† -->
                <el-dialog v-model="v2DetailDialogVisible" :title="`${v2SelectedVariety} - å“ç§è¯¦æƒ…`" width="80%">
                    <div v-if="v2SelectedVariety">
                        <h3 class="text-lg font-bold mb-3">åˆ†æä¿¡å·</h3>
                        <el-table :data="v2VarietySignals" style="margin-bottom: 20px;">
                            <el-table-column prop="åˆ†æç»´åº¦" label="åˆ†æç»´åº¦" width="150" />
                            <el-table-column prop="æ–¹å‘" label="æ–¹å‘" width="100" />
                            <el-table-column prop="æ˜Ÿçº§" label="å¼ºåº¦" width="100" />
                            <el-table-column prop="ç†ç”±" label="ç†ç”±" />
                        </el-table>

                        <h3 class="text-lg font-bold mb-3 mt-6">æœŸé™ç»“æ„</h3>
                        <el-table :data="v2VarietyTermStructure">
                            <el-table-column prop="äº¤å‰²æœˆä»½" label="äº¤å‰²æœˆä»½" width="120" />
                            <el-table-column prop="åˆçº¦æ€»æ•°" label="åˆçº¦æ€»æ•°" width="120" />
                            <el-table-column prop="çœ‹æ¶¨æ•°é‡" label="çœ‹æ¶¨æ•°é‡" width="120" />
                            <el-table-column prop="çœ‹è·Œæ•°é‡" label="çœ‹è·Œæ•°é‡" width="120" />
                            <el-table-column prop="PCR" label="PCR" width="100" />
                            <el-table-column label="è¡Œæƒä»·èŒƒå›´" width="200">
                                <template #default="scope">
                                    {{ scope.row.æœ€ä½è¡Œæƒä»· }} - {{ scope.row.æœ€é«˜è¡Œæƒä»· }}
                                </template>
                            </el-table-column>
                        </el-table>
                    </div>
                </el-dialog>
            </div>

            <!-- å“ç§è¯¦æƒ…é¡µ -->
            <div v-if="activeTab === 'variety-detail'" class="space-y-6">
                <div class="glass-card">
                    <h2 class="text-xl font-bold mb-6 text-gray-800">ğŸ” å“ç§è¯¦æƒ…æŸ¥è¯¢</h2>

                    <!-- æœç´¢æ¡† -->
                    <div class="flex items-center space-x-4 mb-6">
                        <el-input
                            v-model="searchQuery"
                            placeholder="æœç´¢å“ç§ (æ”¯æŒä»£ç å¦‚ C æˆ–åç§°å¦‚ ç‰ç±³)"
                            prefix-icon="Search"
                            @keyup.enter="handleSearchVariety"
                            class="flex-1">
                        </el-input>
                        <el-button type="primary" @click="handleSearchVariety">æœç´¢</el-button>
                    </div>

                    <!-- å“ç§è¯¦æƒ…å±•ç¤º -->
                    <div v-if="selectedVariety">
                        <div class="mb-6 pb-4 border-b border-gray-200">
                            <h3 class="text-2xl font-bold text-gray-800">
                                <span class="variety-badge">{{ selectedVariety.code }}</span>
                                {{ selectedVariety.name }}
                            </h3>
                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- æ™ºæ±‡æœŸè®¯æƒ…ç»ª -->
                            <div class="info-section">
                                <h4 class="text-base font-bold mb-3 text-gray-800">ğŸ“ˆ ç ”æŠ¥æœºæ„æƒ…ç»ª</h4>
                                <div v-if="selectedVariety.zhihui">
                                    <div class="mb-3">
                                        <span class="font-bold text-gray-700">ä¸»æµè§‚ç‚¹: </span>
                                        <span :class="selectedVariety.zhihui.main_sentiment === 'bull' ? 'bull-tag' :
                                                      selectedVariety.zhihui.main_sentiment === 'bear' ? 'bear-tag' : 'neutral-tag'">
                                            {{ selectedVariety.zhihui.more_port }}
                                        </span>
                                        <span class="ml-2 font-bold text-gray-800">{{ selectedVariety.zhihui.more_rate.toFixed(1) }}%</span>
                                    </div>
                                    <div class="sentiment-bar">
                                        <div class="sentiment-bar-bull"
                                             :style="{width: selectedVariety.zhihui.excessive_ratio + '%'}">
                                        </div>
                                        <div class="sentiment-bar-neutral"
                                             :style="{width: selectedVariety.zhihui.neutral_ratio + '%'}">
                                        </div>
                                        <div class="sentiment-bar-bear"
                                             :style="{width: selectedVariety.zhihui.empty_ratio + '%'}">
                                        </div>
                                    </div>
                                    <div class="text-xs text-gray-600 mt-2">
                                        çœ‹å¤š: {{ selectedVariety.zhihui.excessive_num }}å®¶ ({{ selectedVariety.zhihui.excessive_ratio.toFixed(1) }}%) |
                                        ä¸­æ€§: {{ selectedVariety.zhihui.neutral_num }}å®¶ ({{ selectedVariety.zhihui.neutral_ratio.toFixed(1) }}%) |
                                        çœ‹ç©º: {{ selectedVariety.zhihui.empty_num }}å®¶ ({{ selectedVariety.zhihui.empty_ratio.toFixed(1) }}%)
                                    </div>
                                    <div class="text-xs text-gray-500 mt-2">
                                        æ€»æœºæ„æ•°: {{ selectedVariety.zhihui.sum }}å®¶
                                    </div>
                                    <div class="mt-3">
                                        <el-button size="small" type="primary" @click="loadVarietyResearchSummary(selectedVariety.code)">
                                            æŸ¥çœ‹è¯¦ç»†ç ”æŠ¥
                                        </el-button>
                                    </div>
                                </div>
                                <div v-else class="text-gray-500 text-sm">æš‚æ— ç ”æŠ¥æ•°æ®</div>
                            </div>

                            <!-- èµ„é‡‘æµå‘ -->
                            <div class="info-section">
                                <h4 class="text-base font-bold mb-3 text-gray-800">ğŸ’° æœŸæƒèµ„é‡‘æµå‘</h4>
                                <div v-if="selectedVariety.capital">
                                    <div class="mb-2">
                                        <span class="font-bold text-gray-700">å‡€æµå…¥: </span>
                                        <span :class="selectedVariety.capital.total_net_flow > 0 ? 'text-red-500 font-bold text-lg' : 'text-green-600 font-bold text-lg'">
                                            {{ selectedVariety.capital.total_net_flow > 0 ? '+' : '' }}{{ selectedVariety.capital.total_net_flow.toFixed(2) }}ä¸‡
                                        </span>
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        æˆäº¤é‡: {{ selectedVariety.capital.total_volume }}ä¸‡
                                    </div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        è®°å½•æ•°: {{ selectedVariety.capital.count }}
                                    </div>
                                </div>
                                <div v-else class="text-gray-500 text-sm">æš‚æ— èµ„é‡‘æµå‘æ•°æ®</div>
                            </div>

                            <!-- äº¤æ˜“å¯æŸ¥ç­–ç•¥ -->
                            <div class="info-section">
                                <h4 class="text-base font-bold mb-3 text-gray-800">ğŸ“Š äº¤æ˜“å¯æŸ¥ - è“å›¾ç­–ç•¥</h4>
                                <div v-if="selectedVariety.jykStrategy">
                                    <div class="mb-2">
                                        <span :class="selectedVariety.jykStrategy.direction === 'åšå¤š' ? 'bull-tag' : 'bear-tag'">
                                            {{ selectedVariety.jykStrategy.direction }}
                                        </span>
                                        <span class="ml-2 font-bold text-gray-800">{{ selectedVariety.jykStrategy.signal }}</span>
                                    </div>
                                    <div class="text-sm text-gray-600">
                                        {{ selectedVariety.jykStrategy.reason }}
                                    </div>
                                </div>
                                <div v-else class="text-gray-500 text-sm">æš‚æ— è“å›¾ç­–ç•¥</div>
                            </div>

                            <!-- æ–¹æœŸçœ‹ç›˜ -->
                            <div class="info-section">
                                <h4 class="text-base font-bold mb-3 text-gray-800">ğŸ“‰ æ–¹æœŸçœ‹ç›˜</h4>
                                <div class="text-gray-500 text-sm">æ•°æ®æ•´åˆä¸­...</div>
                            </div>
                        </div>

                        <!-- ç ”æŠ¥æ±‡æ€» -->
                        <div v-if="varietyResearchSummary" class="mt-6">
                            <div class="glass-card">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-lg font-bold text-gray-800">ğŸ“ ç ”æŠ¥æ±‡æ€» (å…± {{ varietyResearchSummary.reports_count }} ä»½)</h3>
                                    <div class="flex flex-wrap gap-2">
                                        <span v-for="(report, index) in varietyResearchSummary.reports" :key="index">
                                            <el-tag size="small" :type="getSentimentType(report.sentiment)">
                                                {{ report.institution_name }}: {{ report.view_port }}
                                            </el-tag>
                                        </span>
                                    </div>
                                </div>

                                <!-- äº¤æ˜“é€»è¾‘ -->
                                <div class="bg-gradient-to-r from-blue-50 to-blue-100 p-4 rounded-lg mb-4">
                                    <div class="font-semibold text-gray-700 mb-2 flex items-center">
                                        <span class="text-lg mr-2">ğŸ’¡</span>
                                        <span>äº¤æ˜“é€»è¾‘æ±‡æ€»</span>
                                    </div>
                                    <div class="text-gray-600 leading-relaxed whitespace-pre-wrap text-sm">
                                        {{ varietyResearchSummary.summary.trade_logic || 'æš‚æ— æ•°æ®' }}
                                    </div>
                                </div>

                                <!-- ç›¸å…³æ•°æ® -->
                                <div class="bg-gradient-to-r from-green-50 to-green-100 p-4 rounded-lg mb-4">
                                    <div class="font-semibold text-gray-700 mb-2 flex items-center">
                                        <span class="text-lg mr-2">ğŸ“Š</span>
                                        <span>ç›¸å…³æ•°æ®æ±‡æ€»</span>
                                    </div>
                                    <div class="text-gray-600 leading-relaxed whitespace-pre-wrap text-sm">
                                        {{ varietyResearchSummary.summary.related_data || 'æš‚æ— æ•°æ®' }}
                                    </div>
                                </div>

                                <!-- é£é™©å› ç´  -->
                                <div class="bg-gradient-to-r from-orange-50 to-orange-100 p-4 rounded-lg">
                                    <div class="font-semibold text-gray-700 mb-2 flex items-center">
                                        <span class="text-lg mr-2">âš ï¸</span>
                                        <span>é£é™©å› ç´ æ±‡æ€»</span>
                                    </div>
                                    <div class="text-gray-600 leading-relaxed whitespace-pre-wrap text-sm">
                                        {{ varietyResearchSummary.summary.risk_factor || 'æš‚æ— æ•°æ®' }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- é»˜è®¤æ˜¾ç¤º -->
                    <div v-else class="text-center py-12">
                        <el-empty description="è¯·æœç´¢å“ç§ä»£ç æˆ–åç§°æŸ¥çœ‹è¯¦æƒ…" :image-size="100">
                            <template #default>
                                <p class="text-gray-500 text-sm mb-4">ä¾‹å¦‚: æœç´¢ "C" æˆ– "ç‰ç±³"</p>
                            </template>
                        </el-empty>
                    </div>
                </div>
            </div>

            <!-- åŸºæœ¬é¢é¡µ -->
            <div v-if="activeTab === 'fundamental'" class="space-y-6">
                <el-tabs v-model="fundamentalSubTab" type="border-card">
                    <!-- ç ”æŠ¥å­æ ‡ç­¾ -->
                    <el-tab-pane label="ğŸ“„ ç ”æŠ¥" name="reports">
                        <!-- ç»Ÿè®¡å¡ç‰‡ -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-6">
                            <div class="stat-card">
                                <div class="text-sm text-gray-600 mb-1">æ€»å“ç§æ•°</div>
                                <div class="text-3xl font-bold">{{ zhihuiStats.total_varieties || 0 }}</div>
                            </div>
                            <div class="stat-card">
                                <div class="text-sm text-gray-600 mb-1">çœ‹å¤šå“ç§</div>
                                <div class="text-3xl font-bold text-red-500">
                                    {{ zhihuiStats.sentiment_distribution?.bull?.count || 0 }}
                                    <span class="text-lg ml-2 text-gray-500">
                                        ({{ zhihuiStats.sentiment_distribution?.bull?.ratio || 0 }}%)
                                    </span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="text-sm text-gray-600 mb-1">çœ‹ç©ºå“ç§</div>
                                <div class="text-3xl font-bold text-green-600">
                                    {{ zhihuiStats.sentiment_distribution?.bear?.count || 0 }}
                                    <span class="text-lg ml-2 text-gray-500">
                                        ({{ zhihuiStats.sentiment_distribution?.bear?.ratio || 0 }}%)
                                    </span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="text-sm text-gray-600 mb-1">ä¸­æ€§å“ç§</div>
                                <div class="text-3xl font-bold text-gray-600">
                                    {{ zhihuiStats.sentiment_distribution?.neutral?.count || 0 }}
                                    <span class="text-lg ml-2 text-gray-500">
                                        ({{ zhihuiStats.sentiment_distribution?.neutral?.ratio || 0 }}%)
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- å¸‚åœºæƒ…ç»ªåˆ†å¸ƒå›¾è¡¨ -->
                        <div class="glass-card">
                            <h2 class="text-xl font-bold mb-4 text-gray-800">å¸‚åœºæƒ…ç»ªç»Ÿè®¡</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div id="sentimentPieChart" class="chart-container"></div>
                                <div id="sentimentBarChart" class="chart-container"></div>
                            </div>
                        </div>

                        <!-- å…¨éƒ¨å“ç§ç ”æŠ¥ -->
                        <div class="glass-card">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-xl font-bold text-gray-800">ğŸ“„ å…¨éƒ¨å“ç§ç ”æŠ¥</h2>
                                <el-radio-group v-model="sentimentFilter" @change="fetchZhihuiData" size="small">
                                    <el-radio-button label="">å…¨éƒ¨</el-radio-button>
                                    <el-radio-button label="bull">çœ‹å¤š</el-radio-button>
                                    <el-radio-button label="neutral">ä¸­æ€§</el-radio-button>
                                    <el-radio-button label="bear">çœ‹ç©º</el-radio-button>
                                </el-radio-group>
                            </div>

                            <el-empty v-if="!zhihuiData.length && !loading" description="æš‚æ— ç ”æŠ¥æ•°æ®" :image-size="100"></el-empty>

                            <div v-else-if="loading" class="text-center py-12">
                                <div class="loading-spinner mx-auto"></div>
                                <p class="text-gray-500 mt-4 text-sm">åŠ è½½ä¸­...</p>
                            </div>

                            <el-table v-else :data="zhihuiData" style="width: 100%" :default-sort="{prop: 'excessive_ratio', order: 'descending'}">
                                <el-table-column label="å“ç§" width="180" sortable>
                                    <template #default="scope">
                                        <span class="variety-badge">{{ scope.row.variety_code }}</span>
                                        <span class="font-bold text-gray-800">{{ scope.row.variety_name }}</span>
                                    </template>
                                </el-table-column>
                                <el-table-column label="ä¸»æµè§‚ç‚¹" width="100">
                                    <template #default="scope">
                                        <span :class="scope.row.main_sentiment === 'bull' ? 'bull-tag' :
                                                      scope.row.main_sentiment === 'bear' ? 'bear-tag' : 'neutral-tag'">
                                            {{ scope.row.more_port }}
                                        </span>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="more_rate" label="ä¸»æµå æ¯”" width="90" sortable>
                                    <template #default="scope">
                                        <span class="font-bold text-gray-800">{{ scope.row.more_rate.toFixed(1) }}%</span>
                                    </template>
                                </el-table-column>
                                <el-table-column label="æƒ…ç»ªåˆ†å¸ƒ" min-width="280">
                                    <template #default="scope">
                                        <div class="sentiment-bar">
                                            <div class="sentiment-bar-bull"
                                                 :style="{width: scope.row.excessive_ratio + '%'}"
                                                 :title="'çœ‹å¤š: ' + scope.row.excessive_ratio.toFixed(1) + '%'">
                                            </div>
                                            <div class="sentiment-bar-neutral"
                                                 :style="{width: scope.row.neutral_ratio + '%'}"
                                                 :title="'ä¸­æ€§: ' + scope.row.neutral_ratio.toFixed(1) + '%'">
                                            </div>
                                            <div class="sentiment-bar-bear"
                                                 :style="{width: scope.row.empty_ratio + '%'}"
                                                 :title="'çœ‹ç©º: ' + scope.row.empty_ratio.toFixed(1) + '%'">
                                            </div>
                                        </div>
                                        <div class="text-xs text-gray-500 mt-1">
                                            çœ‹å¤š: {{ scope.row.excessive_num }}å®¶ ({{ scope.row.excessive_ratio.toFixed(1) }}%) |
                                            ä¸­æ€§: {{ scope.row.neutral_num }}å®¶ ({{ scope.row.neutral_ratio.toFixed(1) }}%) |
                                            çœ‹ç©º: {{ scope.row.empty_num }}å®¶ ({{ scope.row.empty_ratio.toFixed(1) }}%)
                                        </div>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="sum" label="æ€»æœºæ„æ•°" width="90" sortable></el-table-column>
                                <el-table-column label="æ“ä½œ" width="120" fixed="right">
                                    <template #default="scope">
                                        <el-button size="small" @click="openResearchDetail(scope.row.variety_code)">
                                            æŸ¥çœ‹ç ”æŠ¥
                                        </el-button>
                                    </template>
                                </el-table-column>
                            </el-table>
                        </div>
                    </el-tab-pane>

                    <!-- å¿«è®¯å­æ ‡ç­¾ -->
                    <el-tab-pane label="ğŸ“° å¿«è®¯" name="news">
                        <div class="glass-card" style="height: 800px;">
                            <h2 class="text-lg font-bold mb-4 text-gray-800">ğŸ“° å®æ—¶å¿«è®¯ (é‡‘åæ•°æ®)</h2>
                            <iframe src="https://www.jin10.com/" width="100%" height="95%" frameborder="0"></iframe>
                        </div>
                    </el-tab-pane>

                    <!-- é‡è¦ä¼šè®®å­æ ‡ç­¾ -->
                    <el-tab-pane label="ğŸ“… é‡è¦ä¼šè®®" name="meetings">
                        <div class="glass-card" style="height: 800px;">
                            <h2 class="text-lg font-bold mb-4 text-gray-800">ğŸ“… æœŸè´§æ—¥å† (é‡‘åæ•°æ®)</h2>
                            <iframe src="https://qihuo.jin10.com/" width="100%" height="95%" frameborder="0"></iframe>
                        </div>
                    </el-tab-pane>
                </el-tabs>
            </div>

            <!-- èµ„é‡‘é¢é¡µ -->
            <div v-if="activeTab === 'capital'" class="space-y-6">
                <div class="glass-card">
                    <h2 class="text-xl font-bold mb-4 text-gray-800">ğŸ’° æœŸæƒèµ„é‡‘æµå‘</h2>
                    <el-empty v-if="!capitalData.length" description="æš‚æ— èµ„é‡‘æµå‘æ•°æ®" :image-size="100"></el-empty>
                    <el-table v-else :data="capitalData" style="width: 100%">
                        <el-table-column label="å“ç§" min-width="200">
                            <template #default="scope">
                                <span class="variety-badge">{{ scope.row.comm_code }}</span>
                                <span class="font-bold text-gray-800">{{ getVarietyName(scope.row.comm_code) }}</span>
                            </template>
                        </el-table-column>
                        <el-table-column label="å‡€æµå…¥(ä¸‡)" min-width="160">
                            <template #default="scope">
                                <span :class="scope.row.total_net_flow > 0 ? 'text-red-500 font-bold' : 'text-green-600 font-bold'">
                                    {{ scope.row.total_net_flow > 0 ? '+' : '' }}{{ scope.row.total_net_flow.toFixed(2) }}
                                </span>
                            </template>
                        </el-table-column>
                        <el-table-column prop="total_volume" label="æˆäº¤é‡(ä¸‡)" min-width="160"></el-table-column>
                        <el-table-column prop="count" label="è®°å½•æ•°" min-width="120"></el-table-column>
                    </el-table>
                </div>
            </div>

            <!-- æŠ€æœ¯é¢é¡µ -->
            <div v-if="activeTab === 'technical'" class="space-y-6">
                <el-tabs v-model="technicalSubTab" type="border-card">
                    <!-- æ³¢åŠ¨ç‡æ›²é¢å­æ ‡ç­¾ -->
                    <el-tab-pane label="ğŸ“Š æ³¢åŠ¨ç‡æ›²é¢" name="volatility-surface">
                        <div class="glass-card">
                            <el-empty description="æ³¢åŠ¨ç‡æ›²é¢åŠŸèƒ½å¼€å‘ä¸­..." :image-size="100"></el-empty>
                        </div>
                    </el-tab-pane>

                    <!-- æ³¢åŠ¨ç‡èƒŒç¦»å­æ ‡ç­¾ -->
                    <el-tab-pane label="ğŸ“‰ æ³¢åŠ¨ç‡èƒŒç¦»" name="volatility-divergence">
                        <div class="glass-card">
                            <el-empty description="æ³¢åŠ¨ç‡èƒŒç¦»åŠŸèƒ½å¼€å‘ä¸­..." :image-size="100"></el-empty>
                        </div>
                    </el-tab-pane>

                    <!-- äº¤æ˜“å¯æŸ¥å­æ ‡ç­¾ -->
                    <el-tab-pane label="ğŸ“‹ äº¤æ˜“å¯æŸ¥" name="trading-strategy">
                        <!-- è§£æç­–ç•¥åˆ—è¡¨ -->
                        <div class="glass-card mb-6">
                            <h2 class="text-xl font-bold mb-4 text-gray-800">ğŸ“‹ {{ selectedDate }} äº¤æ˜“ç­–ç•¥</h2>

                            <!-- æ‰€æœ‰ç­–ç•¥åˆ—è¡¨ (åšå¤š/åšç©ºåˆ†ç±») -->
                            <div v-if="jykStrategies.long.length || jykStrategies.short.length">
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                    <div v-if="jykStrategies.long.length">
                                        <h4 class="text-base font-bold mb-3 text-red-600">ğŸ”¥ åšå¤šç­–ç•¥ ({{ jykStrategies.long.length }}ä¸ª)</h4>
                                        <div class="space-y-2">
                                            <div v-for="(s, idx) in jykStrategies.long" :key="idx" class="p-3 bg-red-50 border border-red-100 rounded hover:border-red-300 transition-all">
                                                <div class="flex justify-between items-start mb-2">
                                                    <div>
                                                        <span class="variety-badge">{{ s.variety }}</span>
                                                        <span class="font-bold text-gray-800">{{ getVarietyName(s.variety) }}</span>
                                                    </div>
                                                    <span class="text-sm">{{ s.signal }}</span>
                                                </div>
                                                <div class="text-sm text-gray-600">{{ s.reason }}</div>
                                            </div>
                                        </div>
                                    </div>
                                    <div v-if="jykStrategies.short.length">
                                        <h4 class="text-base font-bold mb-3 text-green-600">â„ï¸ åšç©ºç­–ç•¥ ({{ jykStrategies.short.length }}ä¸ª)</h4>
                                        <div class="space-y-2">
                                            <div v-for="(s, idx) in jykStrategies.short" :key="idx" class="p-3 bg-green-50 border border-green-100 rounded hover:border-green-300 transition-all">
                                                <div class="flex justify-between items-start mb-2">
                                                    <div>
                                                        <span class="variety-badge">{{ s.variety }}</span>
                                                        <span class="font-bold text-gray-800">{{ getVarietyName(s.variety) }}</span>
                                                    </div>
                                                    <span class="text-sm">{{ s.signal }}</span>
                                                </div>
                                                <div class="text-sm text-gray-600">{{ s.reason }}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <el-empty v-if="!jykStrategies.long.length && !jykStrategies.short.length"
                                description="æš‚æ— ç­–ç•¥è§£ææ•°æ®" :image-size="100"></el-empty>
                        </div>

                        <!-- è“å›¾åŸå›¾ -->
                        <div class="glass-card">
                            <h2 class="text-xl font-bold mb-4 text-gray-800">ğŸ“Š äº¤æ˜“å¯æŸ¥ - æ¯æ—¥äº¤æ˜“è“å›¾</h2>

                            <!-- æ˜¾ç¤ºè“å›¾å›¾ç‰‡ -->
                            <div v-if="blueprintData.local_path">
                                <div class="mb-3">
                                    <span class="text-sm text-gray-600">æ—¥æœŸ: {{ blueprintData.date }}</span>
                                </div>
                                <img :src="'/api/v1/daily/blueprints/image?date=' + selectedDate + '&refresh=' + imageRefreshKey"
                                     :key="'blueprint-' + selectedDate + '-' + imageRefreshKey"
                                     alt="æ¯æ—¥äº¤æ˜“è“å›¾"
                                     class="w-full border border-gray-200 rounded-lg"
                                     @error="handleImageError">
                            </div>

                            <el-empty v-if="!blueprintData.local_path"
                                description="æš‚æ— è“å›¾å›¾ç‰‡" :image-size="100"></el-empty>
                        </div>
                    </el-tab-pane>
                </el-tabs>
            </div>

            <!-- æœŸé™åˆ†æé¡µ -->
            <div v-if="activeTab === 'term-analysis'" class="space-y-6">
                <el-tabs v-model="termAnalysisSubTab" type="border-card">
                    <!-- è™šå®æ¯”å­æ ‡ç­¾ -->
                    <el-tab-pane label="ğŸ“Š è™šå®æ¯”" name="virtual-real-ratio">
                        <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                            <div class="stat-card">
                                <div class="text-sm text-gray-600 mb-1">æ€»å“ç§æ•°</div>
                                <div class="text-3xl font-bold">{{ vrSummary.total_varieties || 0 }}</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                                <div class="text-sm opacity-90 mb-1">é«˜é£é™©å“ç§</div>
                                <div class="text-3xl font-bold">{{ vrSummary.high_risk_count || 0 }}</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                                <div class="text-sm opacity-90 mb-1">ä¸­é£é™©å“ç§</div>
                                <div class="text-3xl font-bold">{{ vrSummary.medium_risk_count || 0 }}</div>
                            </div>
                            <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                                <div class="text-sm opacity-90 mb-1">ä½é£é™©å“ç§</div>
                                <div class="text-3xl font-bold">{{ vrSummary.low_risk_count || 0 }}</div>
                            </div>
                        </div>

                        <!-- é«˜é£é™©å“ç§é¢„è­¦ -->
                        <div class="glass-card" v-if="vrSummary.high_risk_varieties && vrSummary.high_risk_varieties.length">
                            <h2 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                                <span class="text-2xl mr-2">ğŸš¨</span>
                                é«˜é£é™©å“ç§é¢„è­¦
                            </h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div v-for="variety in vrSummary.high_risk_varieties" :key="variety.comm_code"
                                    class="p-4 bg-red-50 border-l-4 border-red-500 rounded hover:shadow-md transition-all cursor-pointer">
                                    <div class="flex justify-between items-start mb-2">
                                        <div>
                                            <h3 class="text-lg font-bold text-gray-800">
                                                {{ variety.variety_name }} ({{ variety.comm_code }})
                                            </h3>
                                            <span class="inline-block bg-red-100 text-red-600 px-3 py-1 rounded text-sm font-semibold">é«˜é£é™©</span>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-2xl font-bold text-red-500">
                                                {{ variety.virtual_real_ratio }}
                                            </div>
                                            <div class="text-sm text-gray-500">è™šå®æ¯”</div>
                                        </div>
                                    </div>
                                    <p class="text-sm text-gray-600 mt-2">{{ variety.impact }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- è™šå®æ¯”æ’è¡Œæ¦œ -->
                        <div class="glass-card">
                            <h2 class="text-xl font-bold text-gray-800 mb-4">ğŸ“ˆ è™šå®æ¯”æ’è¡Œæ¦œ</h2>

                            <!-- ç­›é€‰å™¨ -->
                            <div class="mb-4 flex space-x-4">
                                <el-select v-model="vrFilterRisk" placeholder="é£é™©ç­‰çº§ç­›é€‰" size="small" clearable @change="loadVRData">
                                    <el-option label="å…¨éƒ¨" value=""></el-option>
                                    <el-option label="é«˜é£é™©" value="é«˜"></el-option>
                                    <el-option label="ä¸­é£é™©" value="ä¸­"></el-option>
                                    <el-option label="ä½é£é™©" value="ä½"></el-option>
                                    <el-option label="æ— é£é™©" value="æ— "></el-option>
                                </el-select>
                            </div>

                            <!-- æ•°æ®è¡¨æ ¼ -->
                            <el-table :data="vrList" stripe style="width: 100%">
                                <el-table-column prop="variety_name" label="å“ç§" width="120" fixed>
                                    <template #default="scope">
                                        <strong>{{ scope.row.variety_name }}</strong>
                                        <span class="text-gray-500 text-sm">({{ scope.row.comm_code }})</span>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="virtual_real_ratio" label="è™šå®æ¯”" width="120" sortable>
                                    <template #default="scope">
                                        <span class="text-lg font-bold"
                                            :class="scope.row.virtual_real_ratio > 100 ? 'text-red-500' : 'text-gray-800'">
                                            {{ scope.row.virtual_real_ratio.toFixed(2) }}
                                        </span>
                                    </template>
                                </el-table-column>
                                <el-table-column label="è¾ƒä¸ŠæœŸ" width="110" sortable>
                                    <template #default="scope">
                                        <div v-if="scope.row.ratio_change_pct !== null && scope.row.ratio_change_pct !== undefined">
                                            <div :class="scope.row.ratio_change_pct > 0 ? 'text-red-500' : scope.row.ratio_change_pct < 0 ? 'text-green-500' : 'text-gray-500'"
                                                 class="font-bold">
                                                {{ scope.row.ratio_change_pct > 0 ? 'â†‘' : scope.row.ratio_change_pct < 0 ? 'â†“' : 'â†’' }}
                                                {{ Math.abs(scope.row.ratio_change_pct).toFixed(2) }}%
                                            </div>
                                            <div class="text-xs text-gray-500">
                                                {{ scope.row.ratio_change > 0 ? '+' : '' }}{{ scope.row.ratio_change.toFixed(2) }}
                                            </div>
                                        </div>
                                        <span v-else class="text-gray-400 text-xs">-</span>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="squeeze_risk" label="é€¼ä»“é£é™©" width="100">
                                    <template #default="scope">
                                        <el-tag :type="getVRRiskType(scope.row.squeeze_risk)" size="small">
                                            {{ scope.row.squeeze_risk }}
                                        </el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="receipt_quantity" label="ä»“å•é‡" width="130">
                                    <template #default="scope">
                                        <div>
                                            <div>{{ formatNumber(scope.row.receipt_quantity) }}</div>
                                            <div v-if="scope.row.receipt_change_pct !== null && scope.row.receipt_change_pct !== undefined && scope.row.receipt_change_pct !== 0"
                                                 class="text-xs mt-1">
                                                <span :class="scope.row.receipt_change_pct > 0 ? 'text-green-600' : 'text-red-600'">
                                                    {{ scope.row.receipt_change_pct > 0 ? 'â†‘' : 'â†“' }}
                                                    {{ Math.abs(scope.row.receipt_change_pct).toFixed(1) }}%
                                                </span>
                                            </div>
                                        </div>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="open_interest" label="æŒä»“é‡(æ‰‹)" width="130">
                                    <template #default="scope">
                                        <div>
                                            <div>{{ formatNumber(scope.row.open_interest) }}</div>
                                            <div v-if="scope.row.oi_change_pct !== null && scope.row.oi_change_pct !== undefined && scope.row.oi_change_pct !== 0"
                                                 class="text-xs mt-1">
                                                <span :class="scope.row.oi_change_pct > 0 ? 'text-red-600' : 'text-green-600'">
                                                    {{ scope.row.oi_change_pct > 0 ? 'â†‘' : 'â†“' }}
                                                    {{ Math.abs(scope.row.oi_change_pct).toFixed(1) }}%
                                                </span>
                                            </div>
                                        </div>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="price_pressure" label="ä»·æ ¼å‹åŠ›" width="100">
                                    <template #default="scope">
                                        <el-tag :type="getVRPressureType(scope.row.price_pressure)" size="small">
                                            {{ scope.row.price_pressure }}
                                        </el-tag>
                                    </template>
                                </el-table-column>
                                <el-table-column prop="impact_analysis" label="å½±å“åˆ†æ" min-width="280">
                                </el-table-column>
                                <el-table-column label="æ“ä½œ" width="100" fixed="right">
                                    <template #default="scope">
                                        <el-button size="small" type="primary" @click="viewVRDetail(scope.row.comm_code)">
                                            è¯¦æƒ…
                                        </el-button>
                                    </template>
                                </el-table-column>
                            </el-table>
                        </div>

                        <!-- è¯¦æƒ…å¯¹è¯æ¡† -->
                        <el-dialog v-model="vrDetailDialogVisible" :title="vrDetailData ? `${vrDetailData.variety_name} (${vrDetailData.comm_code}) è™šå®æ¯”è¯¦æƒ…` : 'è™šå®æ¯”è¯¦æƒ…'" width="900px">
                            <div v-if="vrDetailData">
                                <el-descriptions :column="2" border>
                                    <el-descriptions-item label="å“ç§">
                                        {{ vrDetailData.variety_name }} ({{ vrDetailData.comm_code }})
                                    </el-descriptions-item>
                                    <el-descriptions-item label="è®°å½•æ—¥æœŸ">
                                        {{ vrDetailData.record_date }}
                                    </el-descriptions-item>
                                    <el-descriptions-item label="è™šå®æ¯”">
                                        <span class="text-xl font-bold text-red-500">
                                            {{ vrDetailData.virtual_real_ratio.toFixed(2) }}
                                        </span>
                                    </el-descriptions-item>
                                    <el-descriptions-item label="é€¼ä»“é£é™©">
                                        <el-tag :type="getVRRiskType(vrDetailData.squeeze_risk)">
                                            {{ vrDetailData.squeeze_risk }}
                                        </el-tag>
                                    </el-descriptions-item>
                                    <el-descriptions-item label="ä»“å•é‡">
                                        {{ formatNumber(vrDetailData.receipt_quantity) }}
                                    </el-descriptions-item>
                                    <el-descriptions-item label="ä»“å•å˜åŒ–">
                                        <span :class="vrDetailData.receipt_change > 0 ? 'text-green-500' : 'text-red-500'">
                                            {{ vrDetailData.receipt_change > 0 ? '+' : '' }}{{ formatNumber(vrDetailData.receipt_change) }}
                                        </span>
                                    </el-descriptions-item>
                                    <el-descriptions-item label="æŒä»“é‡(æ‰‹)">
                                        {{ formatNumber(vrDetailData.open_interest) }}
                                    </el-descriptions-item>
                                    <el-descriptions-item label="æŒä»“å˜åŒ–">
                                        <span :class="vrDetailData.open_interest_change > 0 ? 'text-green-500' : 'text-red-500'">
                                            {{ vrDetailData.open_interest_change > 0 ? '+' : '' }}{{ formatNumber(vrDetailData.open_interest_change) }}
                                        </span>
                                    </el-descriptions-item>
                                    <el-descriptions-item label="è™šç›˜é‡">
                                        {{ formatNumber(vrDetailData.virtual_quantity) }}
                                    </el-descriptions-item>
                                    <el-descriptions-item label="åˆçº¦å•ä½">
                                        {{ vrDetailData.contract_unit }} åƒå…‹/æ‰‹
                                    </el-descriptions-item>
                                    <el-descriptions-item label="ä»·æ ¼å‹åŠ›" span="2">
                                        <el-tag :type="getVRPressureType(vrDetailData.price_pressure)">
                                            {{ vrDetailData.price_pressure }}
                                        </el-tag>
                                    </el-descriptions-item>
                                    <el-descriptions-item label="å½±å“åˆ†æ" span="2">
                                        {{ vrDetailData.impact_analysis }}
                                    </el-descriptions-item>
                                </el-descriptions>

                                <!-- å†å²è¶‹åŠ¿å›¾è¡¨ -->
                                <div class="mt-6">
                                    <h3 class="text-lg font-bold text-gray-800 mb-4">ğŸ“Š å†å²è¶‹åŠ¿ (è¿‘30å¤©)</h3>
                                    <div id="vrTrendChart" style="width: 100%; height: 400px;"></div>
                                </div>
                            </div>
                        </el-dialog>
                    </el-tab-pane>

                    <!-- æœŸé™ç»“æ„å­æ ‡ç­¾ -->
                    <el-tab-pane label="ğŸ“ˆ æœŸé™ç»“æ„" name="term-structure">
                        <div class="glass-card" style="padding: 16px;">
                            <div class="flex justify-between items-center mb-3">
                                <h2 class="text-base font-bold text-gray-800">ğŸ“ˆ æœŸé™ç»“æ„åˆ†æ</h2>
                                <div class="text-xs text-gray-500" v-if="allTermStructures">
                                    æ›´æ–°: {{ allTermStructures.contango_varieties?.[0]?.update_time?.split(' ')[0] }}
                                </div>
                            </div>

                            <!-- åŠ è½½çŠ¶æ€ -->
                            <div v-if="!allTermStructures" class="text-center py-6">
                                <div class="loading-spinner mx-auto"></div>
                                <p class="text-gray-500 mt-2 text-xs">åŠ è½½ä¸­...</p>
                            </div>

                            <!-- æ‰€æœ‰å“ç§çš„æœŸé™ç»“æ„ -->
                            <div v-else>
                                <!-- ç»Ÿè®¡æ¦‚è§ˆ -->
                                <div class="grid grid-cols-3 gap-2 mb-3">
                                    <div class="stat-card" style="padding: 6px;">
                                        <div class="text-xs text-gray-600 mb-0.5">æ€»å“ç§æ•°</div>
                                        <div class="text-lg font-bold">{{ allTermStructures.total_varieties || 0 }}</div>
                                    </div>
                                    <div class="stat-card" style="border-color: #f56c6c; padding: 6px;">
                                        <div class="text-xs text-gray-600 mb-0.5">Contango (åšç©º)</div>
                                        <div class="text-lg font-bold text-red-500">{{ allTermStructures.contango_count || 0 }}</div>
                                    </div>
                                    <div class="stat-card" style="border-color: #67c23a; padding: 6px;">
                                        <div class="text-xs text-gray-600 mb-0.5">Backwardation (åšå¤š)</div>
                                        <div class="text-lg font-bold text-green-600">{{ allTermStructures.backwardation_count || 0 }}</div>
                                    </div>
                                </div>

                                <!-- åˆ†Tabæ˜¾ç¤º -->
                                <el-tabs v-model="termStructureSubTab" type="border-card">
                                    <!-- æ¨èå“ç§Tab -->
                                    <el-tab-pane v-if="recommendedVarieties.length > 0" name="recommended">
                                        <template #label>
                                            <span class="text-sm">â­ æ¨è ({{ recommendedVarieties.length }}ä¸ª)</span>
                                        </template>
                                        <div class="grid grid-cols-4 gap-2">
                                            <div v-for="variety in recommendedVarieties" :key="'rec_' + variety.variety_code"
                                                 class="glass-card border-2"
                                                 :class="variety.grade === 'S' ? 'border-yellow-500' : 'border-yellow-300'"
                                                 style="padding: 8px;">
                                                <div class="mb-1">
                                                    <span class="variety-badge" style="font-size: 10px; padding: 1px 6px;">{{ variety.variety_code }}</span>
                                                    <el-tag v-if="variety.grade === 'S'" type="warning" size="small" effect="dark" style="font-size: 10px; padding: 0 4px; height: 18px; line-height: 18px;">â­S</el-tag>
                                                    <el-tag v-else type="warning" size="small" style="font-size: 10px; padding: 0 4px; height: 18px; line-height: 18px;">A</el-tag>
                                                </div>
                                                <div class="text-xs font-semibold mb-1" style="font-size: 11px;">{{ variety.variety_name || getVarietyName(variety.variety_code) }}</div>
                                                <el-tag :type="variety.market_structure === 'æ­£å‘å¸‚åœº' ? 'danger' : 'success'" size="small" style="font-size: 10px; padding: 0 4px; height: 18px; line-height: 18px; margin-bottom: 4px;">
                                                    {{ variety.trade_suggestion }}
                                                </el-tag>
                                                <div class="text-xs text-gray-500" style="font-size: 10px; margin-bottom: 4px;">åˆ†: {{ variety.structure_score?.toFixed(0) || 0 }}</div>
                                                <div :id="'termChart_rec_' + variety.variety_code" style="width: 100%; height: 180px;"></div>
                                            </div>
                                        </div>
                                    </el-tab-pane>

                                    <!-- Contango Tab (åŒ…å«æ‰€æœ‰æ­£å‘å¸‚åœºå“ç§) -->
                                    <el-tab-pane v-if="allTermStructures.contango_varieties && allTermStructures.contango_varieties.length" name="contango">
                                        <template #label>
                                            <span class="text-sm">ğŸ”´ Contango ({{ allTermStructures.contango_count }}ä¸ª)</span>
                                        </template>
                                        <div class="grid grid-cols-4 gap-2">
                                            <div v-for="variety in allTermStructures.contango_varieties" :key="'con_' + variety.variety_code"
                                                 class="glass-card"
                                                 :class="{ 'border-2 border-yellow-400': variety.grade === 'S' || variety.grade === 'A' }"
                                                 style="padding: 8px;">
                                                <div class="mb-1">
                                                    <span class="variety-badge" style="font-size: 10px; padding: 1px 6px;">{{ variety.variety_code }}</span>
                                                    <el-tag v-if="variety.grade === 'S'" type="warning" size="small" effect="dark" style="font-size: 10px; padding: 0 4px; height: 18px; line-height: 18px;">â­S</el-tag>
                                                    <el-tag v-else-if="variety.grade === 'A'" type="warning" size="small" style="font-size: 10px; padding: 0 4px; height: 18px; line-height: 18px;">A</el-tag>
                                                    <el-tag v-else-if="variety.grade === 'B'" type="info" size="small" style="font-size: 10px; padding: 0 4px; height: 18px; line-height: 18px;">B</el-tag>
                                                </div>
                                                <div class="text-xs font-semibold mb-1" style="font-size: 11px;">{{ variety.variety_name || getVarietyName(variety.variety_code) }}</div>
                                                <el-tag type="danger" size="small" style="font-size: 10px; padding: 0 4px; height: 18px; line-height: 18px; margin-bottom: 4px;">{{ variety.trade_suggestion }}</el-tag>
                                                <div class="text-xs text-gray-500" style="font-size: 10px; margin-bottom: 4px;">åˆ†: {{ variety.structure_score?.toFixed(0) || 0 }}</div>
                                                <div :id="'termChart_' + variety.variety_code" style="width: 100%; height: 180px;"></div>
                                            </div>
                                        </div>
                                    </el-tab-pane>

                                    <!-- Backwardation Tab (åŒ…å«æ‰€æœ‰åå‘å¸‚åœºå“ç§) -->
                                    <el-tab-pane v-if="allTermStructures.backwardation_varieties && allTermStructures.backwardation_varieties.length" name="backwardation">
                                        <template #label>
                                            <span class="text-sm">ğŸŸ¢ Backwardation ({{ allTermStructures.backwardation_count }}ä¸ª)</span>
                                        </template>
                                        <div class="grid grid-cols-4 gap-2">
                                            <div v-for="variety in allTermStructures.backwardation_varieties" :key="'back_' + variety.variety_code"
                                                 class="glass-card"
                                                 :class="{ 'border-2 border-yellow-400': variety.grade === 'S' || variety.grade === 'A' }"
                                                 style="padding: 8px;">
                                                <div class="mb-1">
                                                    <span class="variety-badge" style="font-size: 10px; padding: 1px 6px;">{{ variety.variety_code }}</span>
                                                    <el-tag v-if="variety.grade === 'S'" type="warning" size="small" effect="dark" style="font-size: 10px; padding: 0 4px; height: 18px; line-height: 18px;">â­S</el-tag>
                                                    <el-tag v-else-if="variety.grade === 'A'" type="warning" size="small" style="font-size: 10px; padding: 0 4px; height: 18px; line-height: 18px;">A</el-tag>
                                                    <el-tag v-else-if="variety.grade === 'B'" type="info" size="small" style="font-size: 10px; padding: 0 4px; height: 18px; line-height: 18px;">B</el-tag>
                                                </div>
                                                <div class="text-xs font-semibold mb-1" style="font-size: 11px;">{{ variety.variety_name || getVarietyName(variety.variety_code) }}</div>
                                                <el-tag type="success" size="small" style="font-size: 10px; padding: 0 4px; height: 18px; line-height: 18px; margin-bottom: 4px;">{{ variety.trade_suggestion }}</el-tag>
                                                <div class="text-xs text-gray-500" style="font-size: 10px; margin-bottom: 4px;">åˆ†: {{ variety.structure_score?.toFixed(0) || 0 }}</div>
                                                <div :id="'termChart_' + variety.variety_code" style="width: 100%; height: 180px;"></div>
                                            </div>
                                        </div>
                                    </el-tab-pane>
                                </el-tabs>
                            </div>
                        </div>
                    </el-tab-pane>
                </el-tabs>
            </div>

            <!-- æ¶ˆæ¯é¢é¡µ -->
            <div v-if="activeTab === 'news'" class="space-y-6">
                <div class="glass-card" style="height: 800px;">
                    <h2 class="text-lg font-bold mb-4 text-gray-800">ğŸ“° å®æ—¶å¿«è®¯ (é‡‘åæ•°æ®)</h2>
                    <iframe src="https://www.jin10.com/" width="100%" height="95%" frameborder="0"></iframe>
                </div>
            </div>
        </main>
    </div>

    <script>
        const { createApp, ref, onMounted, watch } = Vue;
        const { ElMessage } = ElementPlus;

        const app = createApp({
            setup() {
                const activeTab = ref('overview');
                const searchQuery = ref('');
                const selectedDate = ref(new Date().toISOString().split('T')[0]); // YYYY-MM-DD format
                const loading = ref(false);

                // Data refs
                const zhihuiData = ref([]);
                const zhihuiStats = ref({});
                const sentimentFilter = ref('');
                const capitalData = ref([]);
                const jykStrategies = ref({ long: [], short: [] });
                const blueprintData = ref({});
                const threeStarOpportunities = ref([]); // 3æ˜Ÿå¼ºçƒˆæƒ³æ³•
                const twoStarOpportunities = ref([]); // 2æ˜Ÿä¸­ç­‰æƒ³æ³•
                const oneStarOpportunities = ref([]); // 1æ˜Ÿä¿å®ˆæƒ³æ³•
                const selectedVariety = ref(null);
                const varietyMap = ref({}); // Code -> Name mapping
                const imageRefreshKey = ref(0); // ç”¨äºå¼ºåˆ¶åˆ·æ–°å›¾ç‰‡
                const varietyResearchSummary = ref(null); // å“ç§è¯¦æƒ…é¡µé¢çš„ç ”æŠ¥æ±‡æ€»

                // V2åˆ†ææ•°æ® refs
                const v2AllData = ref([]);
                const v2FilteredData = ref([]);
                const v2FilterDirection = ref('all');
                const v2Stats = ref({ total: 0, long: 0, short: 0, neutral: 0 });
                const v2Loading = ref(false);
                const v2DetailDialogVisible = ref(false);
                const v2SelectedVariety = ref(null);
                const v2VarietySignals = ref([]);
                const v2VarietyTermStructure = ref([]);

                // Sub-tab refs
                const fundamentalSubTab = ref('reports');  // åŸºæœ¬é¢å­æ ‡ç­¾
                const technicalSubTab = ref('trading-strategy');  // æŠ€æœ¯é¢å­æ ‡ç­¾
                const termAnalysisSubTab = ref('virtual-real-ratio');  // æœŸé™åˆ†æå­æ ‡ç­¾

                // Virtual-Real Ratio data refs
                const vrSummary = ref({
                    total_varieties: 0,
                    high_risk_count: 0,
                    medium_risk_count: 0,
                    low_risk_count: 0,
                    high_risk_varieties: []
                });
                const vrList = ref([]);
                const vrFilterRisk = ref('');
                const vrDetailDialogVisible = ref(false);
                const vrDetailData = ref(null);

                // Term Structure data refs
                const termStructureVariety = ref('');
                const termStructureData = ref(null);
                const allTermStructures = ref(null);  // æ‰€æœ‰å“ç§çš„æœŸé™ç»“æ„æ•°æ®
                const recommendedVarieties = ref([]);  // æ¨èå“ç§ï¼ˆS/Açº§ï¼‰
                const termStructureSubTab = ref('recommended');  // æœŸé™ç»“æ„å­Tab,é»˜è®¤æ˜¾ç¤ºæ¨è

                // API Base URL - è‡ªåŠ¨æ£€æµ‹æœ¬åœ°æˆ–å…¬ç½‘ç¯å¢ƒ
                // APIé…ç½® - è‡ªåŠ¨é€‚é…æœ¬åœ°å’Œå…¬ç½‘ç¯å¢ƒ
                const API_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                    ? 'http://localhost:8000/api/v1'
                    : `${window.location.origin}/api/v1`;

                // æœŸé™ç»“æ„APIä½¿ç”¨ç‹¬ç«‹è·¯å¾„
                const TERM_STRUCTURE_BASE = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
                    ? 'http://localhost:8000/api/term-structure'
                    : `${window.location.origin}/api/term-structure`;

                // è·å–æœ€è¿‘çš„äº¤æ˜“æ—¥
                const getLatestTradingDate = async () => {
                    try {
                        // å°è¯•ä»æ™ºæ±‡æ•°æ®åº“è·å–æœ€æ–°äº¤æ˜“æ—¥
                        const res = await fetch(`${API_BASE}/fundamental/zhihui/latest-date`);
                        if (res.ok) {
                            const data = await res.json();
                            return data.latest_date; // YYYY-MM-DDæ ¼å¼
                        }
                    } catch (e) {
                        console.error('Failed to fetch latest trading date:', e);
                    }

                    // å¦‚æœAPIè°ƒç”¨å¤±è´¥,å›é€€åˆ°æœ¬åœ°é€»è¾‘
                    const today = new Date();
                    const dayOfWeek = today.getDay();

                    // å‘¨å…­(6)å›é€€1å¤©åˆ°å‘¨äº”, å‘¨æ—¥(0)å›é€€2å¤©åˆ°å‘¨äº”
                    let daysToSubtract = 0;
                    if (dayOfWeek === 0) { // å‘¨æ—¥
                        daysToSubtract = 2;
                    } else if (dayOfWeek === 6) { // å‘¨å…­
                        daysToSubtract = 1;
                    }

                    if (daysToSubtract > 0) {
                        today.setDate(today.getDate() - daysToSubtract);
                    }

                    return today.toISOString().split('T')[0];
                };

                // Convert date format YYYY-MM-DD to YYYYMMDD
                const formatDateForApi = (dateStr) => {
                    return dateStr.replace(/-/g, '');
                };

                // Fetch Zhihui market sentiment data
                const fetchZhihuiData = async () => {
                    try {
                        loading.value = true;
                        const params = new URLSearchParams();
                        params.append('target_date', formatDateForApi(selectedDate.value));
                        if (sentimentFilter.value) {
                            params.append('sentiment_filter', sentimentFilter.value);
                        }

                        const res = await fetch(`${API_BASE}/fundamental/zhihui/market-sentiment?${params}`);
                        if (res.ok) {
                            zhihuiData.value = await res.json();
                            // Build variety map from zhihui data
                            zhihuiData.value.forEach(item => {
                                varietyMap.value[item.variety_code] = item.variety_name;
                            });
                        } else {
                            zhihuiData.value = [];
                        }
                    } catch (e) {
                        console.error('Failed to fetch Zhihui data:', e);
                    } finally {
                        loading.value = false;
                    }
                };

                // Fetch commodity mapping from database
                const fetchCommodityMapping = async () => {
                    try {
                        const res = await fetch(`${API_BASE}/fundamental/commodities/mapping`);
                        if (res.ok) {
                            const mapping = await res.json();
                            // Merge with existing varietyMap
                            Object.assign(varietyMap.value, mapping);
                        }
                    } catch (e) {
                        console.error('Failed to fetch commodity mapping:', e);
                    }
                };

                // Fetch Zhihui stats
                const fetchZhihuiStats = async () => {
                    try {
                        const res = await fetch(`${API_BASE}/fundamental/zhihui/sentiment-stats?target_date=${formatDateForApi(selectedDate.value)}`);
                        if (res.ok) {
                            zhihuiStats.value = await res.json();
                            // Render charts after getting stats (only when in reports tab)
                            if (activeTab.value === 'reports') {
                                setTimeout(() => {
                                    renderSentimentPieChart();
                                    renderSentimentBarChart();
                                }, 100);
                            }
                        }
                    } catch (e) {
                        console.error('Failed to fetch Zhihui stats:', e);
                    }
                };

                // Get variety name by code
                const getVarietyName = (code) => {
                    return varietyMap.value[code] || code;
                };

                // Go to variety detail
                const goToVarietyDetail = (code) => {
                    searchQuery.value = code;
                    activeTab.value = 'variety-detail';
                    setTimeout(() => {
                        handleSearchVariety();
                    }, 100);
                };

                // Handle search variety
                const handleSearchVariety = async () => {
                    if (!searchQuery.value) {
                        ElMessage.warning('è¯·è¾“å…¥å“ç§ä»£ç æˆ–åç§°');
                        return;
                    }

                    const query = searchQuery.value.trim().toUpperCase();

                    // Search in zhihuiData
                    let variety = zhihuiData.value.find(v =>
                        v.variety_code === query ||
                        v.variety_name === searchQuery.value.trim() ||
                        v.variety_code.includes(query) ||
                        v.variety_name.includes(searchQuery.value.trim())
                    );

                    if (!variety) {
                        // If not found in loaded data, fetch all data
                        await fetchZhihuiData();
                        variety = zhihuiData.value.find(v =>
                            v.variety_code === query ||
                            v.variety_name === searchQuery.value.trim() ||
                            v.variety_code.includes(query) ||
                            v.variety_name.includes(searchQuery.value.trim())
                        );
                    }

                    if (variety) {
                        // Fetch capital data for this variety
                        const capitalItem = capitalData.value.find(c => c.comm_code === variety.variety_code);

                        // Fetch JYK strategy
                        const jykLong = jykStrategies.value.long.find(s => s.variety === variety.variety_code);
                        const jykShort = jykStrategies.value.short.find(s => s.variety === variety.variety_code);
                        const jykStrategy = jykLong || jykShort;

                        selectedVariety.value = {
                            code: variety.variety_code,
                            name: variety.variety_name,
                            zhihui: variety,
                            capital: capitalItem,
                            jykStrategy: jykStrategy
                        };

                        ElMessage.success(`æ‰¾åˆ°å“ç§: ${variety.variety_name} (${variety.variety_code})`);
                    } else {
                        selectedVariety.value = null;
                        ElMessage.warning(`æœªæ‰¾åˆ°å“ç§: ${searchQuery.value}`);
                    }
                };

                // Open research detail page
                const openResearchDetail = (varietyCode) => {
                    const url = `/report-detail?code=${varietyCode}&date=${selectedDate.value}`;
                    window.open(url, '_blank');
                };

                // Load variety research summary for variety detail page
                const loadVarietyResearchSummary = async (varietyCode) => {
                    try {
                        const response = await fetch(
                            `${API_BASE}/zhihui/research-summary?comm_code=${varietyCode}&query_date=${selectedDate.value}`
                        );
                        if (response.ok) {
                            const data = await response.json();
                            if (data.success) {
                                varietyResearchSummary.value = data;
                            } else {
                                varietyResearchSummary.value = null;
                            }
                        }
                    } catch (error) {
                        console.error('åŠ è½½ç ”æŠ¥æ±‡æ€»å¤±è´¥:', error);
                        varietyResearchSummary.value = null;
                    }
                };

                // Get sentiment type for Element Plus tag
                const getSentimentType = (sentiment) => {
                    const map = {
                        'bull': 'danger',
                        'bear': 'success',
                        'neutral': 'info'
                    };
                    return map[sentiment] || 'info';
                };

                // Render sentiment pie chart
                const renderSentimentPieChart = () => {
                    const chartDom = document.getElementById('sentimentPieChart');
                    if (!chartDom || !zhihuiStats.value.sentiment_distribution) return;

                    const myChart = echarts.init(chartDom);
                    const option = {
                        title: {
                            text: 'å¸‚åœºæƒ…ç»ªåˆ†å¸ƒ',
                            left: 'center',
                            textStyle: {
                                color: '#2c3e50',
                                fontSize: 16
                            }
                        },
                        tooltip: {
                            trigger: 'item',
                            formatter: '{a} <br/>{b}: {c} ({d}%)'
                        },
                        legend: {
                            orient: 'vertical',
                            left: 'left'
                        },
                        series: [
                            {
                                name: 'æƒ…ç»ªåˆ†å¸ƒ',
                                type: 'pie',
                                radius: '60%',
                                data: [
                                    {
                                        value: zhihuiStats.value.sentiment_distribution.bull.count,
                                        name: 'çœ‹å¤š',
                                        itemStyle: { color: '#f56c6c' }
                                    },
                                    {
                                        value: zhihuiStats.value.sentiment_distribution.neutral.count,
                                        name: 'ä¸­æ€§',
                                        itemStyle: { color: '#909399' }
                                    },
                                    {
                                        value: zhihuiStats.value.sentiment_distribution.bear.count,
                                        name: 'çœ‹ç©º',
                                        itemStyle: { color: '#67c23a' }
                                    }
                                ],
                                emphasis: {
                                    itemStyle: {
                                        shadowBlur: 10,
                                        shadowOffsetX: 0,
                                        shadowColor: 'rgba(0, 0, 0, 0.3)'
                                    }
                                }
                            }
                        ]
                    };
                    myChart.setOption(option);
                };

                // Render sentiment bar chart
                const renderSentimentBarChart = () => {
                    const chartDom = document.getElementById('sentimentBarChart');
                    if (!chartDom || !zhihuiStats.value.sentiment_distribution) return;

                    const myChart = echarts.init(chartDom);
                    const option = {
                        title: {
                            text: 'æƒ…ç»ªå æ¯”ç»Ÿè®¡',
                            left: 'center',
                            textStyle: {
                                color: '#2c3e50',
                                fontSize: 16
                            }
                        },
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'shadow'
                            }
                        },
                        xAxis: {
                            type: 'category',
                            data: ['çœ‹å¤š', 'ä¸­æ€§', 'çœ‹ç©º']
                        },
                        yAxis: {
                            type: 'value',
                            name: 'å“ç§æ•°é‡'
                        },
                        series: [
                            {
                                data: [
                                    {
                                        value: zhihuiStats.value.sentiment_distribution.bull.count,
                                        itemStyle: { color: '#f56c6c' }
                                    },
                                    {
                                        value: zhihuiStats.value.sentiment_distribution.neutral.count,
                                        itemStyle: { color: '#909399' }
                                    },
                                    {
                                        value: zhihuiStats.value.sentiment_distribution.bear.count,
                                        itemStyle: { color: '#67c23a' }
                                    }
                                ],
                                type: 'bar',
                                showBackground: true,
                                backgroundStyle: {
                                    color: 'rgba(180, 180, 180, 0.1)'
                                }
                            }
                        ]
                    };
                    myChart.setOption(option);
                };

                // V2åˆ†ææ•°æ®åŠ è½½å‡½æ•°
                const loadV2Data = async () => {
                    try {
                        v2Loading.value = true;
                        const response = await fetch(`${API_BASE}/analysis-v2/overview`);
                        const result = await response.json();

                        if (result.success) {
                            v2AllData.value = result.data;
                            v2Stats.value = result.stats;
                            handleV2FilterChange();
                            ElMessage.success('V2åˆ†ææ•°æ®åŠ è½½æˆåŠŸ');
                        } else {
                            ElMessage.error('V2æ•°æ®åŠ è½½å¤±è´¥');
                        }
                    } catch (error) {
                        console.error('åŠ è½½V2æ•°æ®å¤±è´¥:', error);
                        ElMessage.error('è¯·æ±‚å¤±è´¥: ' + error.message);
                    } finally {
                        v2Loading.value = false;
                    }
                };

                // V2ç­›é€‰å¤„ç†
                const handleV2FilterChange = () => {
                    if (v2FilterDirection.value === 'all') {
                        v2FilteredData.value = v2AllData.value;
                    } else {
                        v2FilteredData.value = v2AllData.value.filter(
                            item => item.ç»¼åˆæ–¹å‘ === v2FilterDirection.value
                        );
                    }
                };

                // æŸ¥çœ‹V2å“ç§è¯¦æƒ…
                const viewV2Detail = async (variety) => {
                    v2SelectedVariety.value = variety;
                    v2DetailDialogVisible.value = true;

                    try {
                        // åŠ è½½åˆ†æä¿¡å·
                        const signalsResponse = await fetch(`${API_BASE}/analysis-v2/variety/${variety}/signals`);
                        const signalsResult = await signalsResponse.json();
                        if (signalsResult.success) {
                            v2VarietySignals.value = signalsResult.signals;
                        }

                        // åŠ è½½æœŸé™ç»“æ„
                        const termResponse = await fetch(`${API_BASE}/analysis-v2/variety/${variety}/term-structure`);
                        const termResult = await termResponse.json();
                        if (termResult.success) {
                            v2VarietyTermStructure.value = termResult.term_structure;
                        }
                    } catch (error) {
                        console.error('åŠ è½½è¯¦æƒ…å¤±è´¥:', error);
                        ElMessage.error('åŠ è½½è¯¦æƒ…å¤±è´¥');
                    }
                };

                // åˆ·æ–°V2æ•°æ®
                const refreshV2Data = async () => {
                    try {
                        v2Loading.value = true;
                        ElMessage.info('æ­£åœ¨é‡æ–°è¿è¡Œåˆ†æç³»ç»Ÿï¼Œè¯·ç¨å€™...');

                        const response = await fetch(`${API_BASE}/analysis-v2/refresh`, {
                            method: 'POST'
                        });
                        const result = await response.json();

                        if (result.success) {
                            ElMessage.success('åˆ†æå®Œæˆï¼Œæ­£åœ¨é‡æ–°åŠ è½½æ•°æ®...');
                            await loadV2Data();
                        } else {
                            ElMessage.error('åˆ†æå¤±è´¥: ' + result.detail);
                        }
                    } catch (error) {
                        console.error('åˆ·æ–°å¤±è´¥:', error);
                        ElMessage.error('åˆ·æ–°å¤±è´¥: ' + error.message);
                    } finally {
                        v2Loading.value = false;
                    }
                };

                const fetchCapitalData = async () => {
                    try {
                        const res = await fetch(`${API_BASE}/capital/option-flow/all?hours=24`);
                        const data = await res.json();
                        capitalData.value = data.varieties || [];
                    } catch (e) {
                        console.error('Failed to fetch capital data:', e);
                    }
                };

                const fetchJYKStrategies = async () => {
                    try {
                        const res = await fetch(`${API_BASE}/daily/blueprints?date=${selectedDate.value}`);
                        const data = await res.json();
                        blueprintData.value = data;

                        if (data.parsed_strategies) {
                            const strategies = JSON.parse(data.parsed_strategies);

                            // æ˜Ÿçº§è®¡æ•°å‡½æ•°
                            const countStars = (signal) => (signal || '').split('â­').length - 1;

                            // æŒ‰æ˜Ÿçº§æ’åºï¼ˆä¸‰æ˜Ÿâ†’ä¸¤æ˜Ÿâ†’ä¸€æ˜Ÿï¼‰
                            const sortByStars = (a, b) => {
                                const starsA = countStars(a.signal);
                                const starsB = countStars(b.signal);
                                return starsB - starsA; // é™åºæ’åˆ—
                            };

                            // åˆ†ç±»ç­–ç•¥å¹¶æ’åº
                            const longStrategies = strategies.filter(s => s.direction === 'åšå¤š');
                            const shortStrategies = strategies.filter(s => s.direction === 'åšç©º');

                            jykStrategies.value = {
                                long: longStrategies.sort(sortByStars),
                                short: shortStrategies.sort(sortByStars)
                            };

                            // æŒ‰æ˜Ÿçº§åˆ†ç±»
                            threeStarOpportunities.value = strategies.filter(s => countStars(s.signal) === 3);
                            twoStarOpportunities.value = strategies.filter(s => countStars(s.signal) === 2);
                            oneStarOpportunities.value = strategies.filter(s => countStars(s.signal) === 1);
                        } else {
                            jykStrategies.value = { long: [], short: [] };
                            threeStarOpportunities.value = [];
                            twoStarOpportunities.value = [];
                            oneStarOpportunities.value = [];
                        }
                    } catch (e) {
                        console.error('Failed to fetch JYK strategies:', e);
                    }
                };

                const handleImageError = (e) => {
                    console.error('Failed to load blueprint image');
                };

                // Virtual-Real Ratio functions
                const loadVRData = async () => {
                    try {
                        // Load summary
                        const summaryRes = await fetch(
                            `${API_BASE}/virtual-real-ratio/summary?query_date=${selectedDate.value}`
                        );
                        if (summaryRes.ok) {
                            vrSummary.value = await summaryRes.json();
                        }

                        // Load list data
                        let listUrl = `${API_BASE}/virtual-real-ratio/list?query_date=${selectedDate.value}`;
                        if (vrFilterRisk.value) {
                            listUrl += `&risk_level=${vrFilterRisk.value}`;
                        }
                        const listRes = await fetch(listUrl);
                        if (listRes.ok) {
                            vrList.value = await listRes.json();
                        }
                    } catch (error) {
                        console.error('Failed to load VR data:', error);
                        ElMessage.error('åŠ è½½è™šå®æ¯”æ•°æ®å¤±è´¥');
                    }
                };

                const getVRRiskType = (risk) => {
                    const map = {
                        'é«˜': 'danger',
                        'ä¸­': 'warning',
                        'ä½': 'info',
                        'æ— ': 'success'
                    };
                    return map[risk] || 'info';
                };

                const getVRPressureType = (pressure) => {
                    const map = {
                        'ä¸Šæ¶¨': 'danger',
                        'ä¸‹è·Œ': 'success',
                        'ä¸­æ€§': 'info'
                    };
                    return map[pressure] || 'info';
                };

                const formatNumber = (num) => {
                    return num ? num.toLocaleString() : '0';
                };

                // æŸ¥çœ‹è™šå®æ¯”è¯¦æƒ…
                const viewVRDetail = async (commCode) => {
                    try {
                        // è·å–è¯¦æƒ…æ•°æ®
                        const detailRes = await fetch(
                            `${API_BASE}/virtual-real-ratio/detail/${commCode}?query_date=${selectedDate.value}`
                        );
                        if (detailRes.ok) {
                            vrDetailData.value = await detailRes.json();
                            vrDetailDialogVisible.value = true;

                            // è·å–å†å²æ•°æ®å¹¶æ¸²æŸ“å›¾è¡¨
                            const historyRes = await fetch(`${API_BASE}/virtual-real-ratio/history/${commCode}?days=30`);
                            if (historyRes.ok) {
                                const historyData = await historyRes.json();
                                // ç­‰å¾…å¯¹è¯æ¡†æ¸²æŸ“å®Œæˆåå†ç»˜åˆ¶å›¾è¡¨
                                setTimeout(() => {
                                    renderVRTrendChart(historyData);
                                }, 300);
                            }
                        }
                    } catch (error) {
                        console.error('Failed to load VR detail:', error);
                        ElMessage.error('åŠ è½½è¯¦æƒ…å¤±è´¥');
                    }
                };

                // æ¸²æŸ“è™šå®æ¯”è¶‹åŠ¿å›¾è¡¨
                const renderVRTrendChart = (historyData) => {
                    const chartDom = document.getElementById('vrTrendChart');
                    if (!chartDom || !historyData.success) return;

                    const myChart = echarts.init(chartDom);
                    const option = {
                        title: {
                            text: `${historyData.variety_name} è™šå®æ¯”è¶‹åŠ¿ (è¿‘30å¤©)`,
                            left: 'center',
                            textStyle: {
                                color: '#2c3e50',
                                fontSize: 16
                            }
                        },
                        tooltip: {
                            trigger: 'axis',
                            formatter: function(params) {
                                let result = params[0].axisValue + '<br/>';
                                params.forEach(param => {
                                    if (param.seriesName === 'è™šå®æ¯”') {
                                        result += `${param.marker}${param.seriesName}: ${param.value.toFixed(2)}<br/>`;
                                    } else {
                                        result += `${param.marker}${param.seriesName}: ${formatNumber(param.value)}<br/>`;
                                    }
                                });
                                return result;
                            }
                        },
                        legend: {
                            data: ['è™šå®æ¯”', 'ä»“å•é‡', 'æŒä»“é‡'],
                            top: 35
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '3%',
                            containLabel: true
                        },
                        xAxis: {
                            type: 'category',
                            data: historyData.data.dates,
                            axisLabel: {
                                rotate: 45
                            }
                        },
                        yAxis: [
                            {
                                type: 'value',
                                name: 'è™šå®æ¯”',
                                position: 'left',
                                axisLabel: {
                                    formatter: '{value}'
                                }
                            },
                            {
                                type: 'value',
                                name: 'æ•°é‡',
                                position: 'right',
                                axisLabel: {
                                    formatter: function(value) {
                                        return value >= 10000 ? (value / 10000).toFixed(1) + 'ä¸‡' : value;
                                    }
                                }
                            }
                        ],
                        series: [
                            {
                                name: 'è™šå®æ¯”',
                                type: 'line',
                                data: historyData.data.virtual_real_ratios,
                                yAxisIndex: 0,
                                smooth: true,
                                itemStyle: { color: '#f56c6c' },
                                lineStyle: { width: 3 }
                            },
                            {
                                name: 'ä»“å•é‡',
                                type: 'line',
                                data: historyData.data.receipt_quantities,
                                yAxisIndex: 1,
                                smooth: true,
                                itemStyle: { color: '#409eff' }
                            },
                            {
                                name: 'æŒä»“é‡',
                                type: 'line',
                                data: historyData.data.open_interests,
                                yAxisIndex: 1,
                                smooth: true,
                                itemStyle: { color: '#67c23a' }
                            }
                        ]
                    };
                    myChart.setOption(option);
                };

                // Term Structure functions
                const loadTermStructure = async () => {
                    if (!termStructureVariety.value) {
                        ElMessage.warning('è¯·è¾“å…¥å“ç§ä»£ç ');
                        return;
                    }

                    try {
                        const res = await fetch(
                            `${TERM_STRUCTURE_BASE}/structure/${termStructureVariety.value.toUpperCase()}`
                        );
                        if (res.ok) {
                            const data = await res.json();
                            if (data.success) {
                                termStructureData.value = data;
                                // ç­‰å¾…DOMæ›´æ–°åæ¸²æŸ“å›¾è¡¨
                                setTimeout(() => {
                                    renderTermStructureChart();
                                }, 300);
                                ElMessage.success(`æˆåŠŸåŠ è½½ ${data.variety_code} çš„æœŸé™ç»“æ„æ•°æ®`);
                            } else {
                                termStructureData.value = null;
                                ElMessage.warning(data.message || 'æœªæ‰¾åˆ°æ•°æ®');
                            }
                        }
                    } catch (error) {
                        console.error('åŠ è½½æœŸé™ç»“æ„å¤±è´¥:', error);
                        ElMessage.error('åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    }
                };

                const renderTermStructureChart = () => {
                    const chartDom = document.getElementById('termStructureChart');
                    if (!chartDom || !termStructureData.value) return;

                    const myChart = echarts.init(chartDom);
                    const contracts = termStructureData.value.contracts;

                    // è®¡ç®—ä»·æ ¼èŒƒå›´ä»¥ä¼˜åŒ–Yè½´æ˜¾ç¤º
                    const prices = contracts.map(c => c.price);
                    const minPrice = Math.min(...prices);
                    const maxPrice = Math.max(...prices);
                    const priceRange = maxPrice - minPrice;

                    // æ·»åŠ 10%çš„paddingä½¿å›¾è¡¨æ›´ç¾è§‚
                    const padding = priceRange * 0.1;
                    const yAxisMin = Math.floor(minPrice - padding);
                    const yAxisMax = Math.ceil(maxPrice + padding);

                    const option = {
                        title: {
                            text: `${termStructureData.value.variety_code} æœŸé™ç»“æ„`,
                            left: 'center',
                            textStyle: {
                                color: '#2c3e50',
                                fontSize: 18,
                                fontWeight: 'bold'
                            }
                        },
                        tooltip: {
                            trigger: 'axis',
                            formatter: function(params) {
                                const data = params[0];
                                const contract = contracts[data.dataIndex];
                                return `åˆçº¦: ${contract.symbol}<br/>ä»·æ ¼: ${contract.price.toFixed(2)}<br/>æˆäº¤é‡: ${formatNumber(contract.volume)}<br/>æŒä»“é‡: ${formatNumber(contract.open_interest)}`;
                            }
                        },
                        grid: {
                            left: '3%',
                            right: '4%',
                            bottom: '15%',
                            containLabel: true
                        },
                        xAxis: {
                            type: 'category',
                            data: contracts.map(c => c.symbol),
                            name: 'åˆçº¦',
                            axisLabel: {
                                rotate: 45,
                                interval: 0
                            }
                        },
                        yAxis: {
                            type: 'value',
                            name: 'ä»·æ ¼',
                            min: yAxisMin,
                            max: yAxisMax,
                            axisLabel: {
                                formatter: '{value}'
                            }
                        },
                        series: [
                            {
                                name: 'ä»·æ ¼',
                                type: 'line',
                                data: contracts.map(c => c.price),
                                smooth: false,
                                lineStyle: {
                                    width: 3,
                                    color: '#409eff'
                                },
                                itemStyle: {
                                    color: '#409eff',
                                    borderWidth: 2
                                },
                                markPoint: {
                                    data: [
                                        { type: 'max', name: 'æœ€é«˜' },
                                        { type: 'min', name: 'æœ€ä½' }
                                    ]
                                },
                                markLine: {
                                    data: [
                                        { type: 'average', name: 'å¹³å‡' }
                                    ]
                                }
                            }
                        ]
                    };
                    myChart.setOption(option);
                };

                // åŠ è½½æ‰€æœ‰å“ç§çš„æœŸé™ç»“æ„
                const loadAllTermStructures = async () => {
                    try {
                        const res = await fetch(`${TERM_STRUCTURE_BASE}/all-structures`);
                        if (res.ok) {
                            const data = await res.json();
                            if (data.success) {
                                // æŒ‰åˆ†æ•°æ’åºContangoå’ŒBackwardationåˆ—è¡¨
                                const sortedContango = data.contango_varieties.sort((a, b) => {
                                    return (b.structure_score || 0) - (a.structure_score || 0);
                                });

                                const sortedBackwardation = data.backwardation_varieties.sort((a, b) => {
                                    return (b.structure_score || 0) - (a.structure_score || 0);
                                });

                                // æå–æ¨èå“ç§ï¼ˆS/Açº§ï¼‰
                                recommendedVarieties.value = [
                                    ...data.contango_varieties.filter(v => v.grade === 'S' || v.grade === 'A'),
                                    ...data.backwardation_varieties.filter(v => v.grade === 'S' || v.grade === 'A')
                                ].sort((a, b) => {
                                    // Sçº§ä¼˜å…ˆï¼Œç„¶åæŒ‰å¾—åˆ†æ’åº
                                    if (a.grade === 'S' && b.grade !== 'S') return -1;
                                    if (a.grade !== 'S' && b.grade === 'S') return 1;
                                    return (b.structure_score || 0) - (a.structure_score || 0);
                                });

                                // æ›´æ–°æ•°æ®
                                allTermStructures.value = {
                                    ...data,
                                    contango_varieties: sortedContango,
                                    backwardation_varieties: sortedBackwardation,
                                    contango_count: sortedContango.length,
                                    backwardation_count: sortedBackwardation.length
                                };

                                // è®¾ç½®é»˜è®¤Tab - ä¼˜å…ˆæ˜¾ç¤ºæ¨è
                                if (recommendedVarieties.value.length > 0) {
                                    termStructureSubTab.value = 'recommended';
                                } else if (sortedContango.length > 0) {
                                    termStructureSubTab.value = 'contango';
                                } else if (sortedBackwardation.length > 0) {
                                    termStructureSubTab.value = 'backwardation';
                                }

                                // ä½¿ç”¨nextTickç¡®ä¿DOMå·²æ›´æ–°åå†æ¸²æŸ“å›¾è¡¨
                                Vue.nextTick(() => {
                                    setTimeout(() => {
                                        if (termStructureSubTab.value === 'recommended' && recommendedVarieties.value.length > 0) {
                                            console.log('æ¸²æŸ“æ¨èå“ç§å›¾è¡¨:', recommendedVarieties.value.length);
                                            recommendedVarieties.value.forEach((variety, index) => {
                                                setTimeout(() => {
                                                    console.log('æ¸²æŸ“å›¾è¡¨:', variety.variety_code);
                                                    renderSingleTermChart(variety.variety_code, variety.contracts);
                                                }, 100 * (index + 1));
                                            });
                                        } else if (termStructureSubTab.value === 'contango' && sortedContango.length > 0) {
                                            console.log('æ¸²æŸ“Contangoå“ç§å›¾è¡¨:', sortedContango.length);
                                            sortedContango.forEach((variety, index) => {
                                                setTimeout(() => {
                                                    renderSingleTermChart(variety.variety_code, variety.contracts);
                                                }, 100 * (index + 1));
                                            });
                                        } else if (termStructureSubTab.value === 'backwardation' && sortedBackwardation.length > 0) {
                                            console.log('æ¸²æŸ“Backwardationå“ç§å›¾è¡¨:', sortedBackwardation.length);
                                            sortedBackwardation.forEach((variety, index) => {
                                                setTimeout(() => {
                                                    renderSingleTermChart(variety.variety_code, variety.contracts);
                                                }, 100 * (index + 1));
                                            });
                                        }
                                    }, 800);  // å¢åŠ å»¶è¿Ÿç¡®ä¿Tabåˆ‡æ¢åŠ¨ç”»å®Œæˆ
                                });
                            }
                        }
                    } catch (error) {
                        console.error('åŠ è½½æ‰€æœ‰æœŸé™ç»“æ„å¤±è´¥:', error);
                        ElMessage.error('åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
                    }
                };

                // æ¸²æŸ“å•ä¸ªå“ç§çš„æœŸé™ç»“æ„å›¾è¡¨
                const renderSingleTermChart = (varietyCode, contracts) => {
                    // æ ¹æ®å½“å‰tabé€‰æ‹©æ­£ç¡®çš„DOM IDå‰ç¼€
                    let chartDom = null;
                    if (termStructureSubTab.value === 'recommended') {
                        chartDom = document.getElementById(`termChart_rec_${varietyCode}`);
                    } else {
                        // contango å’Œ backwardation éƒ½ä½¿ç”¨æ™®é€šå‰ç¼€
                        chartDom = document.getElementById(`termChart_${varietyCode}`);
                    }

                    if (!chartDom || !contracts || !contracts.length) {
                        console.warn(`å›¾è¡¨DOMæœªæ‰¾åˆ°: ${varietyCode}, tab=${termStructureSubTab.value}`);
                        return;
                    }

                    // è·å–æˆ–åˆ›å»ºEChartså®ä¾‹ï¼ˆé¿å…é‡å¤åˆå§‹åŒ–ï¼‰
                    let myChart = echarts.getInstanceByDom(chartDom);
                    if (!myChart) {
                        myChart = echarts.init(chartDom);
                    }

                    // è®¡ç®—ä»·æ ¼èŒƒå›´ä»¥ä¼˜åŒ–Yè½´æ˜¾ç¤º
                    const prices = contracts.map(c => c.price);
                    const minPrice = Math.min(...prices);
                    const maxPrice = Math.max(...prices);
                    const priceRange = maxPrice - minPrice;

                    // æ·»åŠ 5%çš„paddingä½¿å›¾è¡¨æ›´ç¾è§‚
                    const padding = priceRange * 0.05;
                    const yAxisMin = Math.floor(minPrice - padding);
                    const yAxisMax = Math.ceil(maxPrice + padding);

                    // æ ¹æ®ä»·æ ¼è¶‹åŠ¿åˆ¤æ–­é¢œè‰² (Contangoç”¨çº¢è‰², Backwardationç”¨ç»¿è‰²)
                    const isContango = prices[0] < prices[prices.length - 1];
                    const lineColor = isContango ? '#f56c6c' : '#67c23a';

                    const option = {
                        title: {
                            text: `${varietyCode}`,
                            left: 'center',
                            top: '2',
                            textStyle: {
                                color: '#2c3e50',
                                fontSize: 11,
                                fontWeight: 'bold'
                            }
                        },
                        tooltip: {
                            trigger: 'axis',
                            formatter: function(params) {
                                const data = params[0];
                                const contract = contracts[data.dataIndex];
                                return `${contract.symbol}<br/>ä»·æ ¼: ${contract.price.toFixed(2)}<br/>é‡: ${formatNumber(contract.volume)}`;
                            },
                            textStyle: {
                                fontSize: 10
                            }
                        },
                        grid: {
                            left: '10%',
                            right: '5%',
                            bottom: '18%',
                            top: '15%',
                            containLabel: false
                        },
                        xAxis: {
                            type: 'category',
                            data: contracts.map(c => c.symbol),
                            axisLabel: {
                                rotate: 45,
                                interval: 0,
                                fontSize: 8
                            }
                        },
                        yAxis: {
                            type: 'value',
                            name: '',
                            min: yAxisMin,
                            max: yAxisMax,
                            axisLabel: {
                                formatter: '{value}',
                                fontSize: 8
                            }
                        },
                        series: [
                            {
                                name: 'ä»·æ ¼',
                                type: 'line',
                                data: contracts.map(c => c.price),
                                smooth: false,
                                lineStyle: {
                                    width: 2,
                                    color: lineColor
                                },
                                itemStyle: {
                                    color: lineColor,
                                    borderWidth: 1
                                },
                                areaStyle: {
                                    color: {
                                        type: 'linear',
                                        x: 0,
                                        y: 0,
                                        x2: 0,
                                        y2: 1,
                                        colorStops: [{
                                            offset: 0,
                                            color: isContango ? 'rgba(245, 108, 108, 0.2)' : 'rgba(103, 194, 58, 0.2)'
                                        }, {
                                            offset: 1,
                                            color: isContango ? 'rgba(245, 108, 108, 0.02)' : 'rgba(103, 194, 58, 0.02)'
                                        }]
                                    }
                                }
                            }
                        ]
                    };
                    myChart.setOption(option);
                };

                // æ¸²æŸ“æ‰€æœ‰æœŸé™ç»“æ„å›¾è¡¨
                const renderAllTermStructureCharts = () => {
                    if (!allTermStructures.value) return;

                    // é¦–å…ˆæ¸²æŸ“æ¨èå“ç§ (ä½¿ç”¨rec_å‰ç¼€)
                    if (recommendedVarieties.value && recommendedVarieties.value.length > 0) {
                        recommendedVarieties.value.forEach(variety => {
                            setTimeout(() => {
                                const chartDom = document.getElementById(`termChart_rec_${variety.variety_code}`);
                                if (chartDom) {
                                    renderSingleTermChart(variety.variety_code, variety.contracts);
                                }
                            }, 100);
                        });
                    }

                    // æ¸²æŸ“Contangoå“ç§
                    if (allTermStructures.value.contango_varieties) {
                        allTermStructures.value.contango_varieties.forEach(variety => {
                            setTimeout(() => {
                                renderSingleTermChart(variety.variety_code, variety.contracts);
                            }, 100);
                        });
                    }

                    // æ¸²æŸ“Backwardationå“ç§
                    if (allTermStructures.value.backwardation_varieties) {
                        allTermStructures.value.backwardation_varieties.forEach(variety => {
                            setTimeout(() => {
                                renderSingleTermChart(variety.variety_code, variety.contracts);
                            }, 100);
                        });
                    }
                };

                // æ·»åŠ watch termStructureSubTabæ¥åŠ¨æ€æ¸²æŸ“å›¾è¡¨
                watch(termStructureSubTab, (newSubTab) => {
                    console.log('Tabåˆ‡æ¢åˆ°:', newSubTab);
                    // ä½¿ç”¨Vue.nextTick + setTimeoutç¡®ä¿DOMå®Œå…¨æ›´æ–°
                    Vue.nextTick(() => {
                        setTimeout(() => {
                            if (newSubTab === 'recommended' && recommendedVarieties.value?.length > 0) {
                                console.log('watch: æ¸²æŸ“æ¨èå“ç§', recommendedVarieties.value.length);
                                recommendedVarieties.value.forEach((variety, index) => {
                                    setTimeout(() => {
                                        renderSingleTermChart(variety.variety_code, variety.contracts);
                                    }, 100 * (index + 1));
                                });
                            } else if (newSubTab === 'contango' && allTermStructures.value?.contango_varieties) {
                                console.log('watch: æ¸²æŸ“Contangoå“ç§', allTermStructures.value.contango_varieties.length);
                                allTermStructures.value.contango_varieties.forEach((variety, index) => {
                                    setTimeout(() => {
                                        renderSingleTermChart(variety.variety_code, variety.contracts);
                                    }, 100 * (index + 1));
                                });
                            } else if (newSubTab === 'backwardation' && allTermStructures.value?.backwardation_varieties) {
                                console.log('watch: æ¸²æŸ“Backwardationå“ç§', allTermStructures.value.backwardation_varieties.length);
                                allTermStructures.value.backwardation_varieties.forEach((variety, index) => {
                                    setTimeout(() => {
                                        renderSingleTermChart(variety.variety_code, variety.contracts);
                                    }, 100 * (index + 1));
                                });
                            }
                        }, 600);  // å¢åŠ å»¶è¿Ÿç¡®ä¿Tabåˆ‡æ¢åŠ¨ç”»å®Œæˆ
                    });
                });

                const onDateChange = () => {
                    // æ›´æ–°å›¾ç‰‡åˆ·æ–°é”®ï¼Œå¼ºåˆ¶é‡æ–°åŠ è½½è“å›¾å›¾ç‰‡
                    imageRefreshKey.value++;

                    // Fetch all data when date changes
                    fetchZhihuiStats();
                    fetchZhihuiData();
                    fetchCapitalData();
                    fetchJYKStrategies();
                    loadVRData();
                };

                // Watch activeTab to fetch data when switching tabs
                watch(activeTab, (newTab) => {
                    if (newTab === 'overview') {
                        // Load V2 analysis data for overview tab
                        if (!v2AllData.value.length) loadV2Data();
                    } else if (newTab === 'fundamental') {
                        // Load zhihui data for fundamental tab
                        if (!zhihuiData.value.length) fetchZhihuiData();
                        // Render charts when entering fundamental/reports sub-tab
                        setTimeout(() => {
                            renderSentimentPieChart();
                            renderSentimentBarChart();
                        }, 200);
                    } else if (newTab === 'capital') {
                        if (!capitalData.value.length) fetchCapitalData();
                    } else if (newTab === 'technical') {
                        // Load JYK strategies when entering technical tab
                        if (!jykStrategies.value.long.length && !blueprintData.value.date) fetchJYKStrategies();
                    } else if (newTab === 'variety-detail') {
                        // Load all necessary data for variety detail
                        if (!zhihuiData.value.length) fetchZhihuiData();
                        if (!capitalData.value.length) fetchCapitalData();
                        if (!jykStrategies.value.long.length) fetchJYKStrategies();
                    } else if (newTab === 'term-analysis') {
                        // Load virtual-real ratio data
                        if (!vrList.value.length) loadVRData();
                    }
                });

                // Watch termAnalysisSubTab to load term structure data
                watch(termAnalysisSubTab, (newSubTab) => {
                    if (newSubTab === 'term-structure') {
                        if (!allTermStructures.value) loadAllTermStructures();
                    }
                });

                onMounted(async () => {
                    // é¦–å…ˆè·å–æœ€è¿‘çš„äº¤æ˜“æ—¥æœŸå¹¶è®¾ç½®ä¸ºé»˜è®¤æ—¥æœŸ
                    const latestTradingDate = await getLatestTradingDate();
                    selectedDate.value = latestTradingDate;

                    // ç„¶ååŠ è½½å…¶ä»–æ•°æ®
                    fetchCommodityMapping();  // å…ˆè·å–å“ç§æ˜ å°„
                    fetchZhihuiStats();
                    fetchZhihuiData();
                    loadV2Data();  // åŠ è½½V2åˆ†ææ•°æ®
                });

                return {
                    activeTab,
                    searchQuery,
                    selectedDate,
                    loading,
                    zhihuiData,
                    zhihuiStats,
                    sentimentFilter,
                    capitalData,
                    jykStrategies,
                    blueprintData,
                    threeStarOpportunities,
                    twoStarOpportunities,
                    oneStarOpportunities,
                    selectedVariety,
                    imageRefreshKey,
                    varietyResearchSummary,
                    handleSearchVariety,
                    onDateChange,
                    fetchZhihuiData,
                    getVarietyName,
                    goToVarietyDetail,
                    handleImageError,
                    openResearchDetail,
                    loadVarietyResearchSummary,
                    getSentimentType,
                    // Sub-tabs
                    fundamentalSubTab,
                    technicalSubTab,
                    termAnalysisSubTab,
                    // Virtual-Real Ratio
                    vrSummary,
                    vrList,
                    vrFilterRisk,
                    vrDetailDialogVisible,
                    vrDetailData,
                    loadVRData,
                    getVRRiskType,
                    getVRPressureType,
                    formatNumber,
                    viewVRDetail,
                    // Term Structure
                    termStructureVariety,
                    termStructureData,
                    allTermStructures,
                    recommendedVarieties,
                    termStructureSubTab,
                    loadTermStructure,
                    loadAllTermStructures,
                    renderTermStructureChart,
                    renderAllTermStructureCharts,
                    // V2 Analysis
                    v2AllData,
                    v2FilteredData,
                    v2FilterDirection,
                    v2Stats,
                    v2Loading,
                    v2DetailDialogVisible,
                    v2SelectedVariety,
                    v2VarietySignals,
                    v2VarietyTermStructure,
                    loadV2Data,
                    handleV2FilterChange,
                    viewV2Detail,
                    refreshV2Data
                };
            }
        });

        app.use(ElementPlus);
        app.mount('#app');
    </script>
</body>

</html>
