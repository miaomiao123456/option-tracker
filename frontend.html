<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æœŸæƒäº¤æ˜“è·Ÿè¸ªå™¨ - OptionAlpha</title>
    <!-- EChartså›¾è¡¨åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        /* Tabå¯¼èˆª */
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .tab {
            padding: 12px 24px;
            background: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1em;
            font-weight: 600;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .tab.active {
            background: #667eea;
            color: white;
        }

        /* å†…å®¹åŒºåŸŸ */
        .content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            display: none;
        }

        .content.active {
            display: block;
        }

        /* æœç´¢æ¡† */
        .search-box {
            margin-bottom: 30px;
            display: flex;
            gap: 10px;
        }

        .search-box input {
            flex: 1;
            padding: 12px 20px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
        }

        .search-box button {
            padding: 12px 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .search-box button:hover {
            background: #5568d3;
        }

        /* æ’è¡Œæ¦œå¡ç‰‡ */
        .ranking-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .ranking-card {
            border-radius: 10px;
            padding: 20px;
            color: white;
        }

        .ranking-card.long {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .ranking-card.short {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .ranking-card h3 {
            font-size: 1.3em;
            margin-bottom: 15px;
        }

        .ranking-item {
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .ranking-item:last-child {
            margin-bottom: 0;
        }

        /* å“ç§å¡ç‰‡ */
        .variety-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .variety-card {
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .variety-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
            transform: translateY(-2px);
        }

        .variety-card h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .scores {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .score-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 12px;
            background: #f5f5f5;
            border-radius: 6px;
        }

        .score-value {
            font-weight: 600;
        }

        .score-value.positive {
            color: #f5576c;
        }

        .score-value.negative {
            color: #00f2fe;
        }

        .direction-badge {
            display: inline-block;
            padding: 6px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9em;
        }

        .direction-badge.long {
            background: #f5576c;
            color: white;
        }

        .direction-badge.short {
            background: #00f2fe;
            color: white;
        }

        .direction-badge.neutral {
            background: #999;
            color: white;
        }

        /* å›¾è¡¨å®¹å™¨ */
        .chart-container {
            width: 100%;
            height: 400px;
            margin-top: 20px;
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            text-align: center;
            padding: 50px;
            color: #999;
            font-size: 1.2em;
        }

        .loading::after {
            content: '...';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        /* é‡‘åæ•°æ®iframe */
        .news-iframe {
            width: 100%;
            height: 800px;
            border: none;
            border-radius: 8px;
        }

        /* è¯¦æƒ…æ¨¡æ€æ¡† */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            overflow-y: auto;
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #eee;
        }

        .modal-close {
            font-size: 2em;
            cursor: pointer;
            color: #999;
            line-height: 1;
        }

        .modal-close:hover {
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>æœŸæƒäº¤æ˜“è·Ÿè¸ªå™¨</h1>
            <p>OptionAlpha - å››ç»´åˆ†æç³»ç»Ÿ</p>
        </div>

        <!-- Tabå¯¼èˆª -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('overview')">ğŸ“Š æ€»è§ˆ</button>
            <button class="tab" onclick="switchTab('fundamental')">ğŸ“ˆ åŸºæœ¬é¢</button>
            <button class="tab" onclick="switchTab('capital')">ğŸ’° èµ„é‡‘é¢</button>
            <button class="tab" onclick="switchTab('technical')">ğŸ“‰ æŠ€æœ¯é¢</button>
            <button class="tab" onclick="switchTab('news')">ğŸ“° æ¶ˆæ¯é¢</button>
            <button class="tab" onclick="switchTab('daily')">ğŸ“ æ—¥æŠ¥</button>
        </div>

        <!-- æ€»è§ˆé¡µé¢ -->
        <div id="overview" class="content active">
            <div class="search-box">
                <input type="text" id="searchInput" placeholder="æœç´¢å“ç§ä»£ç æˆ–åç§°ï¼Œå¦‚ï¼šrbã€èºçº¹é’¢">
                <button onclick="searchVariety()">æœç´¢</button>
            </div>

            <div class="ranking-cards">
                <div class="ranking-card long">
                    <h3>ğŸ”¥ ä»Šæ—¥å¤šå¤´ Top3</h3>
                    <div id="topLong"></div>
                </div>
                <div class="ranking-card short">
                    <h3>â„ï¸ ä»Šæ—¥ç©ºå¤´ Top3</h3>
                    <div id="topShort"></div>
                </div>
            </div>

            <h2 style="margin-bottom: 20px; color: #667eea;">å…¨å“ç§æ€»è§ˆ</h2>
            <div id="varietyGrid" class="variety-grid"></div>
        </div>

        <!-- åŸºæœ¬é¢é¡µé¢ -->
        <div id="fundamental" class="content">
            <div class="search-box">
                <input type="text" id="fundamentalSearch" placeholder="è¾“å…¥å“ç§ä»£ç ï¼Œå¦‚ï¼šrb">
                <button onclick="loadFundamental()">æŸ¥è¯¢</button>
            </div>
            <div id="fundamentalContent"></div>
        </div>

        <!-- èµ„é‡‘é¢é¡µé¢ -->
        <div id="capital" class="content">
            <div class="search-box">
                <input type="text" id="capitalSearch" placeholder="è¾“å…¥å“ç§ä»£ç ï¼Œå¦‚ï¼šrb">
                <button onclick="loadCapital()">æŸ¥è¯¢</button>
            </div>
            <div id="capitalContent"></div>
            <div id="capitalChart" class="chart-container"></div>
        </div>

        <!-- æŠ€æœ¯é¢é¡µé¢ -->
        <div id="technical" class="content">
            <div class="search-box">
                <input type="text" id="technicalSearch" placeholder="è¾“å…¥å“ç§ä»£ç ï¼Œå¦‚ï¼šrb">
                <button onclick="loadTechnical()">æŸ¥è¯¢</button>
            </div>
            <div id="technicalContent"></div>
            <div id="technicalChart" class="chart-container"></div>
        </div>

        <!-- æ¶ˆæ¯é¢é¡µé¢ -->
        <div id="news" class="content">
            <h2 style="margin-bottom: 20px; color: #667eea;">é‡‘åæ•°æ® - å®æ—¶èµ„è®¯</h2>
            <iframe src="https://www.jin10.com/" class="news-iframe"></iframe>
        </div>

        <!-- æ—¥æŠ¥é¡µé¢ -->
        <div id="daily" class="content">
            <h2 style="margin-bottom: 20px; color: #667eea;">æ¯æ—¥äº¤æ˜“è“å›¾</h2>
            <div id="blueprintContent"></div>
            <div style="margin-top: 30px;">
                <h3 style="color: #667eea; margin-bottom: 15px;">æœ€æ–°ç­–ç•¥æ¨è</h3>
                <div id="latestStrategies"></div>
            </div>
        </div>
    </div>

    <!-- è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle"></h2>
                <span class="modal-close" onclick="closeModal()">&times;</span>
            </div>
            <div id="modalBody"></div>
        </div>
    </div>

    <script>
        // APIé…ç½®
        const API_BASE = 'http://localhost:8000/api/v1';

        // åˆ‡æ¢Tab
        function switchTab(tabName) {
            // æ›´æ–°Tabæ ·å¼
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');

            // æ›´æ–°å†…å®¹æ˜¾ç¤º
            document.querySelectorAll('.content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');

            // åŠ è½½å¯¹åº”æ•°æ®
            if (tabName === 'overview') loadOverview();
            else if (tabName === 'daily') loadDaily();
        }

        // åŠ è½½æ€»è§ˆæ•°æ®
        async function loadOverview() {
            try {
                // åŠ è½½å¤šç©ºæ’è¡Œ
                const topMovers = await fetch(`${API_BASE}/summary/top-movers?limit=3`).then(r => r.json());

                // æ¸²æŸ“å¤šå¤´Top3
                document.getElementById('topLong').innerHTML = topMovers.long.map((item, index) => `
                    <div class="ranking-item">
                        <span>${index + 1}. ${item.code}</span>
                        <span>æ€»åˆ†: +${item.fundamental_score + item.capital_score + item.technical_score + item.message_score}</span>
                    </div>
                `).join('');

                // æ¸²æŸ“ç©ºå¤´Top3
                document.getElementById('topShort').innerHTML = topMovers.short.map((item, index) => `
                    <div class="ranking-item">
                        <span>${index + 1}. ${item.code}</span>
                        <span>æ€»åˆ†: ${item.fundamental_score + item.capital_score + item.technical_score + item.message_score}</span>
                    </div>
                `).join('');

                // åŠ è½½å…¨å“ç§æ€»è§ˆ
                const overview = await fetch(`${API_BASE}/summary/overview`).then(r => r.json());

                document.getElementById('varietyGrid').innerHTML = overview.map(variety => {
                    const totalScore = variety.fundamental_score + variety.capital_score +
                                     variety.technical_score + variety.message_score;
                    const direction = variety.total_direction;

                    return `
                        <div class="variety-card" onclick="showDetail('${variety.code}')">
                            <h3>${variety.code}</h3>
                            <div class="scores">
                                <div class="score-item">
                                    <span>åŸºæœ¬é¢</span>
                                    <span class="score-value ${variety.fundamental_score > 0 ? 'positive' : 'negative'}">
                                        ${variety.fundamental_score > 0 ? '+' : ''}${variety.fundamental_score}
                                    </span>
                                </div>
                                <div class="score-item">
                                    <span>èµ„é‡‘é¢</span>
                                    <span class="score-value ${variety.capital_score > 0 ? 'positive' : 'negative'}">
                                        ${variety.capital_score > 0 ? '+' : ''}${variety.capital_score}
                                    </span>
                                </div>
                                <div class="score-item">
                                    <span>æŠ€æœ¯é¢</span>
                                    <span class="score-value ${variety.technical_score > 0 ? 'positive' : 'negative'}">
                                        ${variety.technical_score > 0 ? '+' : ''}${variety.technical_score}
                                    </span>
                                </div>
                                <div class="score-item">
                                    <span>æ¶ˆæ¯é¢</span>
                                    <span class="score-value ${variety.message_score > 0 ? 'positive' : 'negative'}">
                                        ${variety.message_score > 0 ? '+' : ''}${variety.message_score}
                                    </span>
                                </div>
                            </div>
                            <div style="margin-top: 15px;">
                                <span class="direction-badge ${direction === 'å¤š' ? 'long' : direction === 'ç©º' ? 'short' : 'neutral'}">
                                    ${direction} (æ€»åˆ†: ${totalScore > 0 ? '+' : ''}${totalScore})
                                </span>
                            </div>
                            <div style="margin-top: 10px; color: #666; font-size: 0.9em;">
                                ${variety.main_reason || 'ç»¼åˆå››ç»´åˆ†æ'}
                            </div>
                        </div>
                    `;
                }).join('');

            } catch (error) {
                console.error('åŠ è½½æ€»è§ˆå¤±è´¥:', error);
                document.getElementById('varietyGrid').innerHTML = '<div class="loading">åŠ è½½å¤±è´¥ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡å·²å¯åŠ¨</div>';
            }
        }

        // æœç´¢å“ç§
        async function searchVariety() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            try {
                const result = await fetch(`${API_BASE}/summary/search?q=${query}`).then(r => r.json());
                if (result.results && result.results.length > 0) {
                    showDetail(result.results[0].code);
                } else {
                    alert('æœªæ‰¾åˆ°å“ç§');
                }
            } catch (error) {
                alert('æœç´¢å¤±è´¥');
            }
        }

        // æ˜¾ç¤ºå“ç§è¯¦æƒ…
        async function showDetail(code) {
            try {
                const summary = await fetch(`${API_BASE}/summary/${code}/summary`).then(r => r.json());
                const positions = await fetch(`${API_BASE}/capital/${code}/top-brokers?limit=10`).then(r => r.json());

                document.getElementById('modalTitle').textContent = `${code} - è¯¦ç»†åˆ†æ`;
                document.getElementById('modalBody').innerHTML = `
                    <h3 style="color: #667eea; margin-bottom: 15px;">å››ç»´è¯„åˆ†</h3>
                    <div class="scores">
                        <div class="score-item">
                            <span>åŸºæœ¬é¢</span>
                            <span class="score-value ${summary.scores.fundamental > 0 ? 'positive' : 'negative'}">
                                ${summary.scores.fundamental > 0 ? '+' : ''}${summary.scores.fundamental}
                            </span>
                        </div>
                        <div class="score-item">
                            <span>èµ„é‡‘é¢</span>
                            <span class="score-value ${summary.scores.capital > 0 ? 'positive' : 'negative'}">
                                ${summary.scores.capital > 0 ? '+' : ''}${summary.scores.capital}
                            </span>
                        </div>
                        <div class="score-item">
                            <span>æŠ€æœ¯é¢</span>
                            <span class="score-value ${summary.scores.technical > 0 ? 'positive' : 'negative'}">
                                ${summary.scores.technical > 0 ? '+' : ''}${summary.scores.technical}
                            </span>
                        </div>
                        <div class="score-item">
                            <span>æ¶ˆæ¯é¢</span>
                            <span class="score-value ${summary.scores.message > 0 ? 'positive' : 'negative'}">
                                ${summary.scores.message > 0 ? '+' : ''}${summary.scores.message}
                            </span>
                        </div>
                    </div>

                    <h3 style="color: #667eea; margin: 25px 0 15px;">ç»¼åˆæ–¹å‘</h3>
                    <p style="font-size: 1.2em;">
                        <span class="direction-badge ${summary.direction === 'å¤š' ? 'long' : 'short'}">
                            ${summary.direction}
                        </span>
                    </p>
                    <p style="margin-top: 10px; color: #666;">${summary.reason}</p>

                    <h3 style="color: #667eea; margin: 25px 0 15px;">Top10 å¤šå¤´å¸­ä½</h3>
                    ${positions.top_long.map((p, i) => `
                        <div style="padding: 10px; background: #f5f5f5; margin-bottom: 8px; border-radius: 6px;">
                            ${i+1}. ${p.broker} - æŒä»“: ${p.position} (å˜åŒ–: ${p.change > 0 ? '+' : ''}${p.change})
                        </div>
                    `).join('')}

                    <h3 style="color: #667eea; margin: 25px 0 15px;">Top10 ç©ºå¤´å¸­ä½</h3>
                    ${positions.top_short.map((p, i) => `
                        <div style="padding: 10px; background: #f5f5f5; margin-bottom: 8px; border-radius: 6px;">
                            ${i+1}. ${p.broker} - æŒä»“: ${p.position} (å˜åŒ–: ${p.change > 0 ? '+' : ''}${p.change})
                        </div>
                    `).join('')}
                `;

                document.getElementById('detailModal').classList.add('active');
            } catch (error) {
                alert('åŠ è½½è¯¦æƒ…å¤±è´¥');
            }
        }

        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('detailModal').classList.remove('active');
        }

        // åŠ è½½åŸºæœ¬é¢æ•°æ®
        async function loadFundamental() {
            const code = document.getElementById('fundamentalSearch').value.trim();
            if (!code) return;

            try {
                const sentiment = await fetch(`${API_BASE}/fundamental/${code}/sentiment?days=7`).then(r => r.json());
                const reports = await fetch(`${API_BASE}/fundamental/${code}/reports?limit=10`).then(r => r.json());

                document.getElementById('fundamentalContent').innerHTML = `
                    <h3 style="color: #667eea; margin-bottom: 15px;">è¿‘7æ—¥æƒ…ç»ªåˆ†æ</h3>
                    <div style="background: #f5f5f5; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                        <p style="font-size: 1.3em; margin-bottom: 10px;">
                            ä¸»æµæƒ…ç»ª: <strong>${sentiment.sentiment === 'bull' ? 'çœ‹å¤š' : sentiment.sentiment === 'bear' ? 'çœ‹ç©º' : 'ä¸­æ€§'}</strong>
                        </p>
                        <p>ç½®ä¿¡åº¦: ${sentiment.confidence}%</p>
                        <p>çœ‹å¤šå æ¯”: ${sentiment.bull_ratio}% | çœ‹ç©ºå æ¯”: ${sentiment.bear_ratio}%</p>
                        <p>æ ·æœ¬æ•°: ${sentiment.sample_size} æ¡</p>
                    </div>

                    <h3 style="color: #667eea; margin-bottom: 15px;">æœ€æ–°ç ”æŠ¥ (${reports.total_reports}æ¡)</h3>
                    ${reports.reports.map(r => `
                        <div style="border-left: 4px solid #667eea; padding: 15px; background: #f9f9f9; margin-bottom: 15px; border-radius: 4px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <strong>${r.source}</strong>
                                <span style="color: #999;">${new Date(r.publish_time).toLocaleDateString()}</span>
                            </div>
                            <div style="margin-bottom: 5px;">
                                <span class="direction-badge ${r.sentiment === 'bull' ? 'long' : r.sentiment === 'bear' ? 'short' : 'neutral'}">
                                    ${r.sentiment === 'bull' ? 'çœ‹å¤š' : r.sentiment === 'bear' ? 'çœ‹ç©º' : 'ä¸­æ€§'}
                                </span>
                            </div>
                            <p style="color: #666;">${r.summary}</p>
                        </div>
                    `).join('')}
                `;
            } catch (error) {
                document.getElementById('fundamentalContent').innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
            }
        }

        // åŠ è½½èµ„é‡‘é¢æ•°æ®
        async function loadCapital() {
            const code = document.getElementById('capitalSearch').value.trim();
            if (!code) return;

            try {
                const flow = await fetch(`${API_BASE}/capital/${code}/flow?days=7`).then(r => r.json());
                const comparison = await fetch(`${API_BASE}/capital/${code}/institution-vs-retail`).then(r => r.json());

                document.getElementById('capitalContent').innerHTML = `
                    <h3 style="color: #667eea; margin-bottom: 15px;">æœºæ„ vs æ•£æˆ·</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                        <div style="background: #f093fb; color: white; padding: 20px; border-radius: 8px;">
                            <h4>æœºæ„æŒä»“</h4>
                            <p style="font-size: 1.5em; margin: 10px 0;">${comparison.institution.direction === 'long' ? 'åšå¤š' : 'åšç©º'}</p>
                            <p>å‡€æŒä»“: ${comparison.institution.net_position}</p>
                            <p>å˜åŒ–: ${comparison.institution.position_change}</p>
                        </div>
                        <div style="background: #4facfe; color: white; padding: 20px; border-radius: 8px;">
                            <h4>æ•£æˆ·æŒä»“</h4>
                            <p style="font-size: 1.5em; margin: 10px 0;">${comparison.retail.direction === 'long' ? 'åšå¤š' : 'åšç©º'}</p>
                            <p>å‡€æŒä»“: ${comparison.retail.net_position}</p>
                            <p>å˜åŒ–: ${comparison.retail.position_change}</p>
                        </div>
                    </div>
                    ${comparison.divergence ? '<div style="background: #fff3cd; padding: 15px; border-radius: 8px; margin-bottom: 20px;"><strong>âš ï¸ æœºæ„ä¸æ•£æˆ·æŒä»“åå‘ï¼Œä¿¡å·è¾ƒå¼º</strong></div>' : ''}
                `;

                // ç»˜åˆ¶èµ„é‡‘æµå‘å›¾è¡¨
                const chart = echarts.init(document.getElementById('capitalChart'));
                chart.setOption({
                    title: { text: 'è¿‘7æ—¥èµ„é‡‘æµå‘' },
                    tooltip: { trigger: 'axis' },
                    xAxis: {
                        type: 'category',
                        data: flow.flow_data.map(d => d.date)
                    },
                    yAxis: { type: 'value' },
                    series: [
                        {
                            name: 'å‡€æŒä»“',
                            type: 'line',
                            data: flow.flow_data.map(d => d.total_net_position)
                        },
                        {
                            name: 'æŒä»“å˜åŒ–',
                            type: 'bar',
                            data: flow.flow_data.map(d => d.total_change)
                        }
                    ]
                });
            } catch (error) {
                document.getElementById('capitalContent').innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
            }
        }

        // åŠ è½½æŠ€æœ¯é¢æ•°æ®
        async function loadTechnical() {
            const code = document.getElementById('technicalSearch').value.trim();
            if (!code) return;

            try {
                const structure = await fetch(`${API_BASE}/technical/${code}/structure`).then(r => r.json());
                const ivHistory = await fetch(`${API_BASE}/technical/${code}/iv-history?days=30`).then(r => r.json());

                document.getElementById('technicalContent').innerHTML = `
                    <h3 style="color: #667eea; margin-bottom: 15px;">æœŸé™ç»“æ„</h3>
                    <div style="background: ${structure.term_structure.type === 'contango' ? '#f093fb' : '#4facfe'}; color: white; padding: 20px; border-radius: 8px; margin-bottom: 30px;">
                        <p style="font-size: 1.5em; margin-bottom: 10px;">${structure.term_structure.type.toUpperCase()}</p>
                        <p>${structure.term_structure.description}</p>
                    </div>
                `;

                // ç»˜åˆ¶æ³¢åŠ¨ç‡å†å²
                const chart = echarts.init(document.getElementById('technicalChart'));
                chart.setOption({
                    title: { text: 'è¿‘30æ—¥éšå«æ³¢åŠ¨ç‡' },
                    tooltip: { trigger: 'axis' },
                    xAxis: {
                        type: 'category',
                        data: ivHistory.iv_history.map(d => new Date(d.time).toLocaleDateString())
                    },
                    yAxis: { type: 'value' },
                    series: [{
                        name: 'IV Rank',
                        type: 'line',
                        data: ivHistory.iv_history.map(d => d.iv_rank),
                        smooth: true
                    }]
                });
            } catch (error) {
                document.getElementById('technicalContent').innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
            }
        }

        // åŠ è½½æ—¥æŠ¥æ•°æ®
        async function loadDaily() {
            try {
                const strategies = await fetch(`${API_BASE}/daily/latest-strategies?limit=10`).then(r => r.json());

                document.getElementById('latestStrategies').innerHTML = strategies.strategies.map(s => `
                    <div style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 20px; margin-bottom: 15px;">
                        <h3 style="color: #667eea; margin-bottom: 10px;">${s.variety_code}</h3>
                        <p style="margin-bottom: 10px;">
                            <span class="direction-badge ${s.direction === 'å¤š' ? 'long' : s.direction === 'ç©º' ? 'short' : 'neutral'}">
                                ${s.direction} (æ€»åˆ†: ${s.total_score > 0 ? '+' : ''}${s.total_score})
                            </span>
                        </p>
                        <p style="color: #666;">${s.reason}</p>
                    </div>
                `).join('');

                // å°è¯•åŠ è½½äº¤æ˜“è“å›¾
                try {
                    const blueprint = await fetch(`${API_BASE}/daily/blueprint`).then(r => r.json());
                    document.getElementById('blueprintContent').innerHTML = `
                        <img src="${blueprint.local_path}" style="max-width: 100%; border-radius: 8px;" alt="äº¤æ˜“è“å›¾">
                        <p style="margin-top: 10px; color: #999;">æ—¥æœŸ: ${blueprint.date}</p>
                    `;
                } catch {
                    document.getElementById('blueprintContent').innerHTML = '<p style="color: #999;">æš‚æ— ä»Šæ—¥äº¤æ˜“è“å›¾</p>';
                }
            } catch (error) {
                document.getElementById('latestStrategies').innerHTML = '<div class="loading">åŠ è½½å¤±è´¥</div>';
            }
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = () => {
            loadOverview();
        };

        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        document.getElementById('detailModal').onclick = (e) => {
            if (e.target.id === 'detailModal') closeModal();
        };
    </script>
</body>
</html>
