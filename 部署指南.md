# 期权交易跟踪器 - 完整部署指南

## 🎉 项目完成度：95%

所有核心功能已开发完成！

## ✅ 已完成的工作

### 1. 后端系统 (100%)
- ✅ FastAPI 框架搭建
- ✅ SQLAlchemy ORM + 6张核心数据表
- ✅ 环境配置管理
- ✅ 完整的API文档（Swagger）

### 2. 爬虫模块 (100%)
- ✅ 交易可查爬虫（登录+席位+蓝图）
- ✅ 智汇期讯爬虫（多空全景+研报）
- ✅ 方期看盘爬虫（早盘/夜盘）
- ✅ Openvlab爬虫（期权合约+背离）
- ✅ 融达数据爬虫（期限结构）

### 3. API接口 (100%)
- ✅ 总览模块（多空排行+搜索）
- ✅ 基本面模块（研报+情绪分析）
- ✅ 资金面模块（席位+资金流）
- ✅ 技术面模块（波动率+结构）
- ✅ 日报模块（蓝图+策略生成）

### 4. 定时任务 (100%)
- ✅ APScheduler 调度器
- ✅ 5个定时爬取任务
- ✅ 自动数据入库

## 🚀 快速开始

### 第一步：安装依赖

```bash
cd /Users/pm/Documents/期权交易策略/option_tracker

# 安装Python依赖
pip install -r requirements.txt

# 安装Playwright浏览器
playwright install chromium
```

### 第二步：配置环境变量

编辑 `.env` 文件（已创建）：
```env
DATABASE_URL=sqlite:///./option_tracker.db
JYK_USER=18321399574
JYK_PASS=yi2013405
GEMINI_API_KEY=sk-IJhu2VBNt2G97XJeE6F82dD8047c4a2989326250068aA1F5
```

### 第三步：启动后端服务

```bash
python main.py
```

访问：
- API文档: http://localhost:8000/docs
- 健康检查: http://localhost:8000/health

### 第四步：测试API

```bash
# 获取多空排行
curl http://localhost:8000/api/v1/summary/top-movers

# 搜索品种
curl http://localhost:8000/api/v1/summary/search?q=rb

# 获取最新策略
curl http://localhost:8000/api/v1/daily/latest-strategies
```

## 📅 定时任务时间表

| 任务 | 时间 | 描述 |
|------|------|------|
| 早盘数据 | 08:55 | 爬取方期看盘早盘提示 |
| 智汇期讯 | 09:00 | 爬取多空全景数据 |
| 夜盘数据 | 20:55 | 爬取方期看盘夜盘提示 |
| 交易蓝图 | 21:05 | 爬取交易可查蓝图图片 |
| 席位持仓 | 21:30 | 爬取主流品种席位数据 |

## 📁 项目结构

```
option_tracker/
├── main.py                          # FastAPI主应用 ⭐
├── requirements.txt                 # 依赖包
├── .env                             # 环境配置
├── option_tracker.db                # SQLite数据库（运行后自动生成）
│
├── config/
│   └── settings.py                  # 配置管理
│
├── app/
│   ├── scheduler.py                 # 定时任务调度器 ⭐
│   │
│   ├── models/
│   │   ├── models.py                # 数据模型（6张表）
│   │   └── database.py              # 数据库连接
│   │
│   ├── crawlers/                    # 爬虫模块 ⭐
│   │   ├── jiaoyikecha_spider.py    # 交易可查
│   │   ├── zhihui_spider.py         # 智汇期讯
│   │   ├── fangqi_spider.py         # 方期看盘
│   │   ├── openvlab_spider.py       # Openvlab
│   │   └── rongda_spider.py         # 融达数据
│   │
│   └── routers/                     # API路由 ⭐
│       ├── summary.py               # 总览API
│       ├── fundamental.py           # 基本面API
│       ├── capital.py               # 资金面API
│       ├── technical.py             # 技术面API
│       └── daily.py                 # 日报API
│
└── 数据存储/
    ├── 交易可查/images/             # 交易蓝图图片
    ├── 方期看盘/data/               # 早晚盘数据JSON
    ├── openvlab/data/               # 期权数据JSON
    └── 融达数据/data/               # 期限结构JSON
```

## 🔌 API使用示例

### 总览模块

```bash
# 获取所有品种总览
GET /api/v1/summary/overview?target_date=2025-11-24

# 获取多空前3名
GET /api/v1/summary/top-movers?limit=3

# 搜索品种
GET /api/v1/summary/search?q=螺纹钢

# 获取单品种总览
GET /api/v1/summary/rb/summary
```

### 基本面模块

```bash
# 获取品种基本面数据
GET /api/v1/fundamental/rb

# 获取研报列表
GET /api/v1/fundamental/rb/reports?limit=20

# 获取情绪分析
GET /api/v1/fundamental/rb/sentiment?days=7
```

### 资金面模块

```bash
# 获取席位持仓
GET /api/v1/capital/rb/positions?limit=20

# 获取资金流向
GET /api/v1/capital/rb/flow?days=7

# 获取Top席位
GET /api/v1/capital/rb/top-brokers?limit=10

# 机构vs散户
GET /api/v1/capital/rb/institution-vs-retail
```

### 技术面模块

```bash
# 获取技术指标
GET /api/v1/technical/rb/indicators

# 获取期限结构
GET /api/v1/technical/rb/structure

# 获取历史波动率
GET /api/v1/technical/rb/iv-history?days=30

# 获取明显结构品种
GET /api/v1/technical/structures/significant
```

### 日报模块

```bash
# 获取交易蓝图
GET /api/v1/daily/blueprint?target_date=2025-11-24

# 生成策略
POST /api/v1/daily/generate-strategy?variety_code=rb

# 获取最新策略
GET /api/v1/daily/latest-strategies?limit=10
```

## 🧪 单独测试爬虫

```bash
cd app/crawlers

# 测试交易可查爬虫
python jiaoyikecha_spider.py

# 测试智汇期讯爬虫
python zhihui_spider.py

# 测试方期看盘爬虫
python fangqi_spider.py

# 测试Openvlab爬虫
python openvlab_spider.py

# 测试融达数据爬虫
python rongda_spider.py
```

## 🎨 前端对接（下一步）

前端可以基于现有的"小橘交易策略系统-V2"进行改造：

### 前端需要做的事情：

1. **修改API调用地址**
   ```javascript
   const API_BASE = 'http://localhost:8000/api/v1';
   ```

2. **总览页面**
   ```javascript
   // 获取多空排行
   fetch(`${API_BASE}/summary/top-movers?limit=3`)
     .then(res => res.json())
     .then(data => {
       // data.long - 做多前3
       // data.short - 做空前3
     });
   ```

3. **详情页面**
   ```javascript
   // 获取品种四维数据
   fetch(`${API_BASE}/summary/rb/summary`)
     .then(res => res.json())
     .then(summary => {
       // summary.scores.fundamental
       // summary.scores.capital
       // summary.scores.technical
       // summary.scores.message
     });

   // 获取席位数据
   fetch(`${API_BASE}/capital/rb/top-brokers`)
     .then(res => res.json())
     .then(data => {
       // data.top_long - 做多席位
       // data.top_short - 做空席位
       // 绘制ECharts图表
     });
   ```

4. **消息面页面**
   ```html
   <!-- 直接嵌入金十数据 -->
   <iframe src="https://www.jin10.com/" width="100%" height="800px"></iframe>
   ```

5. **日报页面**
   ```javascript
   // 获取交易蓝图
   fetch(`${API_BASE}/daily/blueprint`)
     .then(res => res.json())
     .then(data => {
       // 显示图片
       document.querySelector('#blueprint-img').src = data.local_path;

       // 显示解析的策略
       data.strategies.forEach(strategy => {
         // 渲染策略卡片
       });
     });
   ```

## ⚠️ 注意事项

### 爬虫相关

1. **登录问题**
   - 交易可查可能有验证码，首次使用建议 `headless=False` 手动处理
   - Cookie过期需要重新登录

2. **反爬虫**
   - 已添加延迟控制（1-2秒/请求）
   - 使用真实浏览器User-Agent
   - 如遇IP封禁，可考虑代理池

3. **数据稳定性**
   - 网站改版会导致爬虫失效
   - 建议定期检查爬虫运行日志

### 性能优化

1. **数据库索引**
   - 已在 `comm_code` 和 `date` 字段上创建索引
   - 如数据量大，考虑MySQL替换SQLite

2. **缓存**
   - 可添加Redis缓存热点数据
   - 减少数据库查询压力

## 📊 数据库查看

```bash
# 使用SQLite命令行
sqlite3 option_tracker.db

# 查看表
.tables

# 查看席位数据
SELECT * FROM institutional_positions WHERE comm_code='rb' ORDER BY record_date DESC LIMIT 10;

# 查看基本面数据
SELECT * FROM fundamental_reports WHERE comm_code='rb' ORDER BY publish_time DESC LIMIT 10;
```

## 🐛 问题排查

### 启动失败

```bash
# 检查端口占用
lsof -i :8000

# 查看日志
python main.py
```

### 爬虫失败

```bash
# 查看详细日志
logging.basicConfig(level=logging.DEBUG)

# 使用非无头模式调试
await spider.init_browser(headless=False)
```

### 数据库错误

```bash
# 删除数据库重新初始化
rm option_tracker.db
python main.py
```

## 🚀 生产部署建议

1. **使用MySQL数据库**
   ```env
   DATABASE_URL=mysql+pymysql://user:password@localhost:3306/option_tracker
   ```

2. **使用Gunicorn启动**
   ```bash
   pip install gunicorn
   gunicorn main:app -w 4 -k uvicorn.workers.UvicornWorker
   ```

3. **使用Nginx反向代理**

4. **使用Supervisor管理进程**

5. **配置日志轮转**

## 📝 总结

你现在拥有一个完整的期权交易跟踪系统：

✅ **5个数据爬虫** - 覆盖基本面、资金面、技术面
✅ **25+ API接口** - 完整的RESTful API
✅ **5个定时任务** - 全自动数据更新
✅ **6张数据表** - 结构化数据存储
✅ **完整的API文档** - Swagger自动生成

**下一步工作：** 优化前端页面，对接后端API，实现数据可视化！

所有代码都在：`/Users/pm/Documents/期权交易策略/option_tracker/`

祝交易顺利！🎯
