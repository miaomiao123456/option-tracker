<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>V2åˆ†ææ€»è§ˆ - OptionAlpha</title>
    <!-- Vue 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- Element Plus -->
    <link rel="stylesheet" href="https://unpkg.com/element-plus/dist/index.css" />
    <script src="https://unpkg.com/element-plus"></script>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
            background-color: #f5f7fa;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        .header-bar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .content-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 0 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            color: #666;
            margin-top: 5px;
        }

        .direction-long {
            background: #d1fae5;
            color: #065f46;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .direction-short {
            background: #fee2e2;
            color: #991b1b;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }

        .direction-neutral {
            background: #e5e7eb;
            color: #374151;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 13px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="header-bar">
            <div style="max-width: 1400px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1 style="margin: 0; font-size: 28px;">ğŸ“Š V2åˆ†ææ€»è§ˆ</h1>
                    <p style="margin: 5px 0 0 0; opacity: 0.9; font-size: 14px;">5ç»´åº¦æœŸæƒåˆ†æç³»ç»Ÿ</p>
                </div>
                <el-button type="primary" @click="refreshData" :loading="loading">
                    åˆ·æ–°æ•°æ®
                </el-button>
            </div>
        </div>

        <div class="content-container">
            <!-- ç»Ÿè®¡é¢æ¿ -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-number">{{ stats.total }}</div>
                    <div class="stat-label">æ€»å“ç§æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #10b981;">{{ stats.long }}</div>
                    <div class="stat-label">å¤šå¤´å“ç§</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #ef4444;">{{ stats.short }}</div>
                    <div class="stat-label">ç©ºå¤´å“ç§</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" style="color: #6b7280;">{{ stats.neutral }}</div>
                    <div class="stat-label">ä¸­æ€§å“ç§</div>
                </div>
            </div>

            <!-- ç­›é€‰æŒ‰é’® -->
            <el-card style="margin-bottom: 20px;">
                <el-radio-group v-model="filterDirection" @change="handleFilterChange">
                    <el-radio-button label="all">å…¨éƒ¨</el-radio-button>
                    <el-radio-button label="å¤šå¤´">å¤šå¤´</el-radio-button>
                    <el-radio-button label="ç©ºå¤´">ç©ºå¤´</el-radio-button>
                    <el-radio-button label="ä¸­æ€§">ä¸­æ€§</el-radio-button>
                </el-radio-group>
            </el-card>

            <!-- æ•°æ®è¡¨æ ¼ -->
            <el-card>
                <el-table :data="filteredData" stripe style="width: 100%" v-loading="loading">
                    <el-table-column prop="å“ç§" label="å“ç§" width="100" fixed />
                    <el-table-column label="ç»¼åˆæ–¹å‘" width="120">
                        <template #default="scope">
                            <span :class="{
                                'direction-long': scope.row.ç»¼åˆæ–¹å‘ === 'å¤šå¤´',
                                'direction-short': scope.row.ç»¼åˆæ–¹å‘ === 'ç©ºå¤´',
                                'direction-neutral': scope.row.ç»¼åˆæ–¹å‘ === 'ä¸­æ€§'
                            }">
                                {{ scope.row.ç»¼åˆæ–¹å‘ }}
                            </span>
                        </template>
                    </el-table-column>
                    <el-table-column prop="ç»¼åˆæ˜Ÿçº§" label="ç»¼åˆå¼ºåº¦" width="100" />
                    <el-table-column prop="å‡€å¾—åˆ†" label="å‡€å¾—åˆ†" width="100" sortable />

                    <el-table-column label="ç ”æŠ¥" width="120">
                        <template #default="scope">
                            {{ scope.row.ç ”æŠ¥åˆ†æ_æ–¹å‘ }} {{ scope.row.ç ”æŠ¥åˆ†æ_æ˜Ÿçº§ }}
                        </template>
                    </el-table-column>

                    <el-table-column label="è™šå®æ¯”" width="120">
                        <template #default="scope">
                            {{ scope.row.è™šå®æ¯”PCR_æ–¹å‘ }} {{ scope.row.è™šå®æ¯”PCR_æ˜Ÿçº§ }}
                        </template>
                    </el-table-column>

                    <el-table-column label="æœŸé™ç»“æ„" width="140">
                        <template #default="scope">
                            {{ scope.row.æœŸé™ç»“æ„_æ–¹å‘ }} {{ scope.row.æœŸé™ç»“æ„_æ˜Ÿçº§ }}
                        </template>
                    </el-table-column>

                    <el-table-column label="æ³¢åŠ¨ç‡èƒŒç¦»" width="140">
                        <template #default="scope">
                            {{ scope.row.æ³¢åŠ¨ç‡èƒŒç¦»_æ–¹å‘ }} {{ scope.row.æ³¢åŠ¨ç‡èƒŒç¦»_æ˜Ÿçº§ }}
                        </template>
                    </el-table-column>

                    <el-table-column label="èµ„é‡‘é¢" width="120">
                        <template #default="scope">
                            {{ scope.row.èµ„é‡‘é¢_æ–¹å‘ }} {{ scope.row.èµ„é‡‘é¢_æ˜Ÿçº§ }}
                        </template>
                    </el-table-column>

                    <el-table-column label="æ“ä½œ" width="100" fixed="right">
                        <template #default="scope">
                            <el-button type="primary" size="small" @click="viewDetail(scope.row.å“ç§)">
                                è¯¦æƒ…
                            </el-button>
                        </template>
                    </el-table-column>
                </el-table>
            </el-card>
        </div>

        <!-- è¯¦æƒ…å¯¹è¯æ¡† -->
        <el-dialog v-model="detailDialogVisible" title="å“ç§è¯¦æƒ…" width="80%">
            <div v-if="selectedVariety">
                <h3>{{ selectedVariety }} - åˆ†æä¿¡å·</h3>
                <el-table :data="varietySignals" style="margin-bottom: 20px;">
                    <el-table-column prop="åˆ†æç»´åº¦" label="åˆ†æç»´åº¦" />
                    <el-table-column prop="æ–¹å‘" label="æ–¹å‘" />
                    <el-table-column prop="æ˜Ÿçº§" label="å¼ºåº¦" />
                    <el-table-column prop="ç†ç”±" label="ç†ç”±" />
                </el-table>

                <h3>æœŸé™ç»“æ„</h3>
                <el-table :data="varietyTermStructure">
                    <el-table-column prop="äº¤å‰²æœˆä»½" label="äº¤å‰²æœˆä»½" />
                    <el-table-column prop="åˆçº¦æ€»æ•°" label="åˆçº¦æ€»æ•°" />
                    <el-table-column prop="çœ‹æ¶¨æ•°é‡" label="çœ‹æ¶¨æ•°é‡" />
                    <el-table-column prop="çœ‹è·Œæ•°é‡" label="çœ‹è·Œæ•°é‡" />
                    <el-table-column prop="PCR" label="PCR" />
                    <el-table-column label="è¡Œæƒä»·èŒƒå›´">
                        <template #default="scope">
                            {{ scope.row.æœ€ä½è¡Œæƒä»· }} - {{ scope.row.æœ€é«˜è¡Œæƒä»· }}
                        </template>
                    </el-table-column>
                </el-table>
            </div>
        </el-dialog>
    </div>

    <script>
        const { createApp } = Vue;
        const { ElMessage } = ElementPlus;

        createApp({
            data() {
                return {
                    loading: false,
                    allData: [],
                    filteredData: [],
                    filterDirection: 'all',
                    stats: {
                        total: 0,
                        long: 0,
                        short: 0,
                        neutral: 0
                    },
                    detailDialogVisible: false,
                    selectedVariety: null,
                    varietySignals: [],
                    varietyTermStructure: []
                };
            },
            mounted() {
                this.loadData();
            },
            methods: {
                async loadData() {
                    this.loading = true;
                    try {
                        const response = await fetch('/api/v1/analysis-v2/overview');
                        const result = await response.json();

                        if (result.success) {
                            this.allData = result.data;
                            this.stats = result.stats;
                            this.handleFilterChange();
                            ElMessage.success('æ•°æ®åŠ è½½æˆåŠŸ');
                        } else {
                            ElMessage.error('æ•°æ®åŠ è½½å¤±è´¥');
                        }
                    } catch (error) {
                        console.error(error);
                        ElMessage.error('è¯·æ±‚å¤±è´¥: ' + error.message);
                    } finally {
                        this.loading = false;
                    }
                },
                handleFilterChange() {
                    if (this.filterDirection === 'all') {
                        this.filteredData = this.allData;
                    } else {
                        this.filteredData = this.allData.filter(
                            item => item.ç»¼åˆæ–¹å‘ === this.filterDirection
                        );
                    }
                },
                async viewDetail(variety) {
                    this.selectedVariety = variety;
                    this.detailDialogVisible = true;

                    try {
                        // åŠ è½½åˆ†æä¿¡å·
                        const signalsResponse = await fetch(`/api/v1/analysis-v2/variety/${variety}/signals`);
                        const signalsResult = await signalsResponse.json();
                        if (signalsResult.success) {
                            this.varietySignals = signalsResult.signals;
                        }

                        // åŠ è½½æœŸé™ç»“æ„
                        const termResponse = await fetch(`/api/v1/analysis-v2/variety/${variety}/term-structure`);
                        const termResult = await termResponse.json();
                        if (termResult.success) {
                            this.varietyTermStructure = termResult.term_structure;
                        }
                    } catch (error) {
                        console.error(error);
                        ElMessage.error('åŠ è½½è¯¦æƒ…å¤±è´¥');
                    }
                },
                async refreshData() {
                    this.loading = true;
                    try {
                        ElMessage.info('æ­£åœ¨é‡æ–°è¿è¡Œåˆ†æç³»ç»Ÿï¼Œè¯·ç¨å€™...');
                        const response = await fetch('/api/v1/analysis-v2/refresh', {
                            method: 'POST'
                        });
                        const result = await response.json();

                        if (result.success) {
                            ElMessage.success('åˆ†æå®Œæˆï¼Œæ­£åœ¨é‡æ–°åŠ è½½æ•°æ®...');
                            await this.loadData();
                        } else {
                            ElMessage.error('åˆ†æå¤±è´¥: ' + result.detail);
                        }
                    } catch (error) {
                        console.error(error);
                        ElMessage.error('åˆ·æ–°å¤±è´¥: ' + error.message);
                    } finally {
                        this.loading = false;
                    }
                }
            }
        }).use(ElementPlus).mount('#app');
    </script>
</body>
</html>
